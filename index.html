<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOLKPRESSO - Share Stories Share Laughter </title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/751/751621.png">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Midtrans Snap.js Sandbox -->
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-yIcpNrBNbMzCnZzQ"></script>
    <!-- Midtrans Snap.js Sandbox -->
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-yIcpNrBNbMzCnZzQ"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            80% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes brewBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .app-page {
            display: none;
        }

        .app-page.active {
            display: block;
            animation: slideUp 0.4s ease-out;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(16px);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .dark .glass-nav {
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .animate-marquee {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 20s linear infinite;
        }

        .anim-brew {
            animation: brewBounce 1s infinite ease-in-out;
        }

        .member-card-gold {
            background: linear-gradient(135deg, #FFD700, #B8860B);
            color: #FFF;
        }

        .member-card-silver {
            background: linear-gradient(135deg, #E0E0E0, #9E9E9E);
            color: #333;
        }

        .member-card-bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: #FFF;
        }

        .grayscale-mode {
            filter: grayscale(100%);
            pointer-events: none;
            opacity: 0.6;
        }

        #toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            pointer-events: none;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .toast {
            background: #1e3a8a;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: popIn 0.3s forwards;
        }

        #payment-modal,
        #tracking-modal,
        #universal-popup {
            z-index: 9999;
        }

        .kopiku-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 60;
        }

        .dark .kopiku-header {
            background: #0f172a;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .points-card {
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            border-radius: 20px;
            color: white;
        }

        .category-pill {
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            border: 1.5px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-pill.active,
        .category-pill:hover {
            background: #1e3a8a;
            color: white;
            border-color: #1e3a8a;
        }

        .dark .category-pill {
            background: #1e293b;
            border-color: #334155;
            color: #94a3b8;
        }

        .dark .category-pill.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .menu-product-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s;
        }

        .menu-product-card:hover {
            transform: translateY(-2px);
        }

        .dark .menu-product-card {
            background: #1e293b;
            border-color: #334155;
        }

        .notif-tab {
            padding: 8px 24px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notif-tab.active {
            background: #1e3a8a;
            color: white;
        }

        .notif-tab:not(.active) {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-item:hover {
            background: #f8fafc;
        }

        .dark .settings-item {
            border-color: #1e293b;
        }

        .dark .settings-item:hover {
            background: #1e293b;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            padding: 4px 0;
            transition: color 0.2s;
            min-width: 56px;
        }

        .bottom-nav-item.active {
            color: #1e3a8a;
        }

        .dark .bottom-nav-item.active {
            color: #60a5fa;
        }

        .bottom-nav-item .nav-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .bottom-nav-item.active .nav-icon {
            background: #dbeafe;
        }

        .dark .bottom-nav-item.active .nav-icon {
            background: #1e3b6e;
        }
    </style>
</head>

<body
    class="bg-[#EDF2FA] text-slate-900 pb-24 dark:bg-slate-950 dark:text-white transition-colors duration-300 font-sans select-none">

    <div id="toast-container"></div>

    <div id="universal-popup" class="fixed inset-0 hidden items-center justify-center p-6 backdrop-blur-md bg-black/40">
        <div class="bg-white dark:bg-slate-900 w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl transform scale-50 opacity-0 transition-all duration-300"
            id="popup-content">
            <div id="popup-icon" class="text-5xl text-center mb-4">✨</div>
            <h3 id="popup-title" class="text-xl font-black text-center text-blue-900 dark:text-white mb-2">Pemberitahuan
            </h3>
            <p id="popup-message" class="text-sm text-center text-slate-500 dark:text-slate-400 mb-6 font-medium">Pesan
                di sini...</p>
            <div id="popup-actions" class="w-full"></div>
        </div>
    </div>

    <div id="payment-modal"
        class="fixed inset-0 hidden flex items-center justify-center p-6 backdrop-blur-md bg-black/40">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-2xl font-black text-center text-blue-900 dark:text-white mb-6">Pilih Metode Pembayaran</h3>
            <div class="space-y-3">
                <button onclick="processPayment('Cash')"
                    class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform">💵
                    Cash</button>
                <button onclick="processPayment('QRIS')"
                    class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform">📱
                    QRIS</button>
                <button onclick="processPayment('Transfer')"
                    class="w-full bg-purple-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform">🏦
                    Transfer</button>
                <button onclick="closePaymentModal()"
                    class="w-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white py-4 rounded-2xl font-bold">Batal</button>
            </div>
        </div>
    </div>

    <div id="tracking-modal"
        class="fixed inset-0 hidden flex items-center justify-center p-6 backdrop-blur-md bg-black/40">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl text-center">
            <div id="brew-state">
                <div class="text-6xl mb-4 anim-brew">☕</div>
                <h3 id="track-title" class="text-2xl font-black text-blue-900 dark:text-white mb-2">Memproses...</h3>
                <p id="track-desc" class="text-sm text-slate-500 dark:text-slate-400 mb-6">Pesananmu sedang dibuat</p>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-3 rounded-full overflow-hidden">
                    <div id="anim-bar" class="h-full bg-blue-600 transition-all duration-[3000ms]" style="width: 0%">
                    </div>
                </div>
            </div>
            <div id="finish-state" class="hidden flex-col items-center">
                <div class="text-6xl mb-4">✅</div>
                <h3 class="text-2xl font-black text-green-600 mb-2">Pesanan Selesai!</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Terima kasih sudah order!</p>
                <button onclick="finishOrder()"
                    class="w-full bg-blue-900 dark:bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">Oke!</button>
            </div>
        </div>
    </div>

    <!-- ===== LOGIN SCREEN ===== -->
    <div id="login-screen"
        class="fixed inset-0 z-[5000] flex flex-col items-center justify-center p-6 transition-all duration-500"
        style="background: linear-gradient(160deg, #6aacf0 0%, #2563eb 40%, #1e3a8a 100%);">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-[2rem] shadow-2xl mb-5">
                    <span class="text-5xl">☕</span>
                </div>
                <h1 class="text-4xl font-extrabold text-white tracking-tight">FOLKPRESSO</h1>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl">
                <h2 class="text-xl font-extrabold text-slate-800 text-center mb-2">Selamat Datang!</h2>
                <p class="text-sm text-slate-400 text-center mb-8">Silahkan Masuk Untuk Meraih Point dan Menikmati Kopi
                </p>

                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-3 bg-slate-50 rounded-2xl px-4 py-3.5 border border-slate-100">
                        <span class="text-slate-400">📧</span>
                        <input type="email" placeholder="Email"
                            class="bg-transparent flex-1 text-sm font-medium outline-none placeholder-slate-300"
                            disabled>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-50 rounded-2xl px-4 py-3.5 border border-slate-100">
                        <span class="text-slate-400">🔒</span>
                        <input type="password" placeholder="Kata Sandi"
                            class="bg-transparent flex-1 text-sm font-medium outline-none placeholder-slate-300"
                            disabled>
                    </div>
                </div>

                <button onclick="loginWithGoogle()"
                    class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all mb-5">
                    <span id="login-text">Masuk</span>
                </button>

                <div class="flex gap-3 mb-6">
                    <button onclick="loginWithGoogle()"
                        class="flex-1 flex items-center justify-center gap-2 bg-slate-50 hover:bg-slate-100 border border-slate-200 py-3 rounded-2xl transition-all active:scale-95">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-5 h-5">
                        <span class="text-xs font-bold text-slate-600">Google</span>
                    </button>
                    <button onclick="loginWithGoogle()"
                        class="flex-1 flex items-center justify-center gap-2 bg-slate-50 hover:bg-slate-100 border border-slate-200 py-3 rounded-2xl transition-all active:scale-95">
                        <span class="text-lg">📘</span>
                        <span class="text-xs font-bold text-slate-600">Facebook</span>
                    </button>
                </div>

                <p class="text-center text-xs text-slate-400">Belum punya akun? <span
                        class="text-blue-600 font-bold cursor-pointer" onclick="loginWithGoogle()">Daftar
                        Sekarang</span></p>
            </div>
        </div>
        <p class="mt-8 text-xs text-blue-200/50 font-semibold tracking-widest uppercase">© FOLKPRESSO - 2026</p>
    </div>

    <!-- ===== MAIN APP ===== -->
    <div id="main-app" class="hidden">

        <!-- HEADER -->
        <header class="kopiku-header">
            <div class="px-5 py-4 flex justify-between items-center">
                <h1 class="text-xl font-extrabold text-blue-900 dark:text-blue-400 tracking-tight">FOLKPRESSO</h1>
                <div class="flex items-center gap-3">
                    <div id="store-status-badge" class="hidden"><span
                            class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span></div>
                    <div id="broadcast-status" class="flex items-center gap-1">
                        <span id="broadcast-indicator" class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <p id="broadcast-text" class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">
                            Connecting</p>
                    </div>
                    <button onclick="toggleDark()"
                        class="w-9 h-9 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-xl text-sm">🌙</button>
                    <div
                        class="w-9 h-9 flex items-center justify-center bg-blue-50 dark:bg-slate-800 rounded-xl text-sm cursor-pointer">
                        🔔</div>
                </div>
            </div>
        </header>

        <!-- ===== HOME PAGE ===== -->
        <main id="home-page" class="app-page active">
            <!-- User Greeting -->
            <div class="px-5 mt-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="profile-photo-nav" src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
                        class="w-11 h-11 rounded-full border-2 border-blue-500 object-cover shadow-sm">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Halo, FOLK-ers!</p>
                        <h2 id="home-username"
                            class="text-sm font-extrabold text-blue-900 dark:text-white truncate max-w-[140px]">Guest
                        </h2>
                    </div>
                </div>
                <div onclick="window.showPage('profile')"
                    class="points-card px-4 py-2.5 flex items-center gap-2 cursor-pointer shadow-lg">
                    <span class="text-lg">☕</span>
                    <div>
                        <p class="text-[9px] font-medium opacity-80">Your Points</p>
                        <p id="home-points" class="text-lg font-extrabold leading-tight">0</p>
                    </div>
                    <span class="text-white/60 ml-1">›</span>
                </div>
            </div>

            <!-- Community Goal (hidden but functional) -->
            <div class="hidden">
                <span id="goal-counter">0 / 20 Cups</span>
                <div id="goal-bar" class="h-full bg-blue-600 w-0"></div>
            </div>

            <!-- Marquee -->
            <div class="bg-blue-900 dark:bg-blue-950 py-2 mt-4 overflow-hidden border-y border-blue-800/50">
                <div class="animate-marquee text-xs font-bold text-blue-200 tracking-wide">
                    🔥 Fuel Your Day With a Perfect Blend! &nbsp;&nbsp; • &nbsp;&nbsp; FOLKPRESSO Open!
                </div>
            </div>

            <!-- Special Offer Banner -->
            <div class="px-5 mt-5">
                <div class="relative rounded-[1.5rem] overflow-hidden h-40 shadow-lg">
                    <img src="img/1st rend.png" class="w-full h-full object-cover">
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-blue-900/90 to-blue-900/30 flex items-center p-6">
                        <div>
                            <p class="text-[10px] font-bold text-blue-200 uppercase tracking-widest mb-1">Special Offer
                            </p>
                            <h3 class="text-white font-extrabold text-lg leading-snug">30% Off All Lattes<br>With
                                Membership!</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Cards -->
            <div class="px-5 mt-5 grid grid-cols-2 gap-3">
                <div onclick="mysteryBrew()"
                    class="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-[1.5rem] p-5 text-white shadow-lg active:scale-95 transition-transform cursor-pointer">
                    <h4 class="font-extrabold text-sm">Mystery Brew 🎲</h4>
                    <p class="text-[10px] opacity-80 mt-1">Biarkan kami pilih!</p>
                </div>
                <div onclick="claimQuest()" id="quest-card"
                    class="bg-gradient-to-br from-pink-500 to-orange-500 rounded-[1.5rem] p-5 text-white shadow-lg active:scale-95 transition-transform cursor-pointer">
                    <h4 class="font-extrabold text-sm">Daily Quest ⚔️</h4>
                    <p id="quest-status" class="text-[10px] opacity-80 mt-1">Klaim +50 Poin</p>
                </div>
            </div>

            <!-- Popular Now -->
            <div class="px-5 mt-7">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-extrabold text-slate-800 dark:text-white">Popular Now 🔥</h3>
                    <span onclick="showPage('menu')" class="text-xs font-bold text-blue-600 cursor-pointer">See All
                        →</span>
                </div>
            </div>

            <div class="px-5 pb-10 space-y-3" id="product-list"></div>
        </main>

        <!-- ===== MENU PAGE ===== -->
        <main id="menu-page" class="app-page">
            <div class="px-5 pt-6 pb-3 flex items-center gap-3">
                <button onclick="showPage('home')"
                    class="w-10 h-10 bg-white dark:bg-slate-800 rounded-xl flex items-center justify-center shadow-sm text-lg">←</button>
                <h2 class="text-xl font-extrabold text-slate-800 dark:text-white flex-1">Daftar Menu</h2>
                <button
                    class="w-10 h-10 bg-white dark:bg-slate-800 rounded-xl flex items-center justify-center shadow-sm text-sm">⚙️</button>
            </div>

            <div class="px-5 mb-4 flex gap-2 overflow-x-auto no-scrollbar" id="menu-category-tabs">
                <span class="category-pill active" onclick="filterMenu('all')">☕ All</span>
                <span class="category-pill" onclick="filterMenu('signature')">✨ Signature</span>
                <span class="category-pill" onclick="filterMenu('classic')">☕ Classic</span>
                <span class="category-pill" onclick="filterMenu('non-coffee')">🍵 Non-Coffee</span>
            </div>

            <div class="px-5 mb-5">
                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl px-4 py-3 flex items-center gap-3 shadow-sm border border-slate-100 dark:border-slate-700">
                    <span class="text-slate-400">🔍</span>
                    <input type="text" placeholder="Search menu..." id="menu-search" oninput="searchMenu(this.value)"
                        class="bg-transparent flex-1 text-sm font-medium outline-none placeholder-slate-300 dark:text-white">
                </div>
            </div>

            <div class="px-5 pb-10 grid grid-cols-2 gap-3" id="menu-product-grid"></div>
        </main>

        <!-- ===== CART PAGE ===== -->
        <main id="cart-page" class="app-page">
            <div class="px-5 pt-6 pb-3 flex items-center gap-3">
                <button onclick="showPage('home')"
                    class="w-10 h-10 bg-white dark:bg-slate-800 rounded-xl flex items-center justify-center shadow-sm text-lg">←</button>
                <h2 class="text-xl font-extrabold text-blue-900 dark:text-white flex-1">Keranjang Anda</h2>
            </div>

            <div class="px-5">
                <!-- Alamat Pengiriman -->
                <div
                    class="bg-white dark:bg-slate-900 p-4 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 mb-4">
                    <div class="flex items-center gap-2 mb-1">
                        <span>📍</span>
                        <span class="text-xs font-bold text-slate-500 dark:text-slate-400">Alamat Pengiriman</span>
                    </div>
                    <p id="cart-address-display" class="text-sm font-bold text-slate-800 dark:text-white">Belum diatur
                    </p>
                    <p class="text-[10px] text-blue-600 font-bold mt-1 cursor-pointer" onclick="showPage('profile')">
                        Ubah di Profile →</p>
                </div>

                <div id="cart-items" class="space-y-3 min-h-[100px]"></div>

                <div
                    class="mt-6 bg-white dark:bg-slate-900 rounded-[1.5rem] p-5 shadow-lg border border-slate-100 dark:border-slate-800">
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between text-sm"><span
                                class="text-slate-400 font-medium">Subtotal</span><span id="cart-total"
                                class="font-extrabold text-slate-800 dark:text-white">Rp 0</span></div>
                        <div class="flex justify-between text-sm"><span class="text-slate-400 font-medium">Biaya
                                Pengiriman</span><span class="font-extrabold text-green-500">Gratis</span></div>
                        <div
                            class="border-t border-slate-100 dark:border-slate-700 pt-3 flex justify-between text-base">
                            <span class="font-bold text-slate-600 dark:text-slate-300">Total Pembayaran</span><span
                                class="font-extrabold text-blue-900 dark:text-blue-400 text-lg" id="cart-total-final">Rp
                                0</span>
                        </div>
                    </div>
                    <button onclick="window.openPayment()"
                        class="w-full bg-blue-700 hover:bg-blue-800 text-white py-4 rounded-2xl font-extrabold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span>🛒</span> Lanjutkan Pembayaran
                    </button>
                </div>
            </div>
        </main>

        <!-- ===== PROFILE PAGE ===== -->
        <main id="profile-page" class="app-page p-5">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-extrabold text-slate-800 dark:text-white">Profil Pengguna</h3>
                <div class="w-9 h-9 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-xl text-sm">
                    ⚙️</div>
            </div>

            <!-- Profile Info -->
            <div class="flex items-center gap-4 mb-6">
                <div class="w-16 h-16 rounded-full border-3 border-blue-500 overflow-hidden shadow-lg bg-blue-50">
                    <img id="profile-photo-display" src="https://cdn-icons-png.flaticon.com/512/847/847969.png"
                        class="w-full h-full object-cover">
                </div>
                <div>
                    <h4 id="profile-display-name" class="text-lg font-extrabold text-slate-800 dark:text-white">Guest
                    </h4>
                    <p class="text-xs text-slate-400 font-medium">FOLKPRESSO Member</p>
                </div>
            </div>

            <!-- Member Card -->
            <div id="member-card"
                class="member-card-bronze rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6">
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Status Member</p>
                    <h2 id="tier-name" class="text-2xl font-black mt-1">BRONZE MEMBER</h2>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold opacity-80">Total Poin</span>
                        <span id="display-points" class="text-xl font-black">0</span>
                    </div>
                    <div class="w-full bg-white/20 h-2 rounded-full overflow-hidden">
                        <div id="level-bar" class="h-full bg-white transition-all duration-1000" style="width: 0%">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alamat Pengiriman -->
            <div
                class="bg-white dark:bg-slate-900 rounded-[1.5rem] p-5 border border-slate-100 dark:border-slate-800 mb-5">
                <h4 class="font-extrabold text-sm mb-3 text-slate-700 dark:text-white">📍 Alamat Pengiriman</h4>
                <textarea id="input-address" rows="2"
                    class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl p-3 text-sm font-medium outline-none focus:ring-2 focus:ring-blue-500 resize-none dark:text-white"
                    placeholder="Masukkan alamat lengkap..."></textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="getGPSAddress()" id="btn-gps"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold text-xs active:scale-95 transition-all flex items-center justify-center gap-1">
                        📡 Gunakan GPS
                    </button>
                    <button onclick="saveAddress()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold text-xs active:scale-95 transition-all">
                        💾 Simpan Alamat
                    </button>
                </div>
                <p id="gps-status" class="text-[10px] text-slate-400 mt-2 hidden"></p>
            </div>

            <!-- Notifikasi -->
            <div
                class="bg-white dark:bg-slate-900 rounded-[1.5rem] p-5 border border-slate-100 dark:border-slate-800 mb-5">
                <h4 class="font-extrabold text-sm mb-3 text-slate-700 dark:text-white">� Notifikasi</h4>
                <div id="notif-list" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                    <p class="text-xs text-slate-400 italic text-center py-4">Belum ada notifikasi</p>
                </div>
            </div>

            <!-- Riwayat Pesanan -->
            <div
                class="bg-white dark:bg-slate-900 rounded-[1.5rem] p-5 border border-slate-100 dark:border-slate-800 mb-5">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-extrabold text-sm text-slate-700 dark:text-white">📋 Riwayat Pesanan</h4>
                    <button onclick="loadOrderHistory()" class="text-[10px] font-bold text-blue-600">Refresh</button>
                </div>
                <div id="order-history-list" class="space-y-2 max-h-72 overflow-y-auto no-scrollbar">
                    <p class="text-xs text-slate-400 italic text-center py-4">Klik Refresh untuk melihat riwayat</p>
                </div>
            </div>

            <!-- Caffeine Meter -->
            <div
                class="bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 mb-5">
                <h4 class="font-bold text-sm mb-4">⚡ Caffeine Meter</h4>
                <div class="flex items-end gap-3 h-20">
                    <div class="flex-1 bg-slate-100 dark:bg-slate-800 rounded-t-xl relative overflow-hidden h-full">
                        <div id="caffeine-bar"
                            class="absolute bottom-0 w-full bg-orange-400 transition-all duration-1000"
                            style="height: 0%"></div>
                    </div>
                    <div class="text-right">
                        <h5 id="caffeine-mg" class="text-2xl font-black text-orange-500">0<span
                                class="text-xs text-slate-400">mg</span></h5>
                    </div>
                </div>
            </div>

            <!-- Custom Name -->
            <div
                class="bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 mb-5">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nama Custom Kamu</label>
                <div class="flex gap-2 mt-2">
                    <input type="text" id="input-username"
                        class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl p-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Masukkan nama...">
                    <button onclick="updateCustomName()" id="btn-save-name"
                        class="bg-blue-600 text-white px-5 rounded-xl font-bold text-xs active:scale-95 transition-transform">Simpan</button>
                </div>
                <p id="name-change-info" class="text-[10px] text-slate-400 mt-2">*Nama ini akan muncul di aplikasi</p>
            </div>

            <!-- Logout -->
            <button onclick="logout()"
                class="w-full bg-red-50 hover:bg-red-100 text-red-500 py-4 rounded-2xl font-bold transition-colors border border-red-100">
                Keluar Akun
            </button>
        </main>

        <!-- ===== BOTTOM NAV ===== -->
        <nav class="fixed bottom-0 left-0 right-0 z-[80] glass-nav py-2 px-4">
            <div class="flex justify-around">
                <button onclick="showPage('home')" id="btn-home"
                    class="flex flex-col items-center text-blue-900 dark:text-blue-400">
                    <div class="nav-icon"
                        style="background:#dbeafe;border-radius:12px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;">
                        🏠</div>
                    <span class="text-[10px] font-bold mt-1">Home</span>
                </button>
                <button onclick="showPage('menu')" id="btn-menu" class="flex flex-col items-center text-slate-400">
                    <div class="nav-icon">📋</div>
                    <span class="text-[10px] font-bold mt-1">Menu</span>
                </button>
                <button onclick="showPage('cart')" id="btn-cart"
                    class="flex flex-col items-center text-slate-400 relative">
                    <div class="nav-icon">🛒</div>
                    <span class="text-[10px] font-bold mt-1">Cart</span>
                </button>
                <button onclick="showPage('profile')" id="btn-profile"
                    class="flex flex-col items-center text-slate-400">
                    <div class="nav-icon">👤</div>
                    <span class="text-[10px] font-bold mt-1">Profile</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // === SUPABASE CONFIG ===
        var SB_URL = "https://gfmvigkhflkqetbftttr.supabase.co";
        var SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmbXZpZ2toZmxrcWV0YmZ0dHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTQ3NDAsImV4cCI6MjA4NTYzMDc0MH0.dGq7S_3y2nG8Nrl_ZpzLVuncoedp2rlIzb2u4cZ44Fg";
        var defaultMarquee = `🔥 "Aren Latte-nya juara!" - Andi &nbsp;&nbsp; • &nbsp;&nbsp; 🎵 Now Playing: The 1975 &nbsp;&nbsp; • &nbsp;&nbsp; ☕ Folkpresso Open!`;
        var marqueeTimer;
        var marqueeResetTimer = null;
        var activeMessages = []; // pesan-pesan yang sedang ditampilkan di marquee
        var isDisplayingMarquee = false;

        window.displayMarqueeMessage = function (message, timestamp) {
            console.log("📢 displayMarqueeMessage called:", message, "timestamp:", timestamp);
            var marqueeEl = document.querySelector('.animate-marquee');

            if (!marqueeEl) {
                console.error("❌ Marquee element not found!");
                return;
            }

            // Cek duplikat pesan (hindari pesan yang sama muncul lagi)
            if (activeMessages.indexOf(message) !== -1) {
                console.log("⏭️ Duplicate message, skipping:", message);
                return;
            }

            console.log("✅ Adding message to active display");

            // Tambahkan pesan ke daftar aktif
            activeMessages.push(message);

            // Update indicator
            updateBroadcastIndicator();

            // Reset timer setiap kali pesan baru masuk (perpanjang tampilan)
            if (marqueeResetTimer) {
                clearTimeout(marqueeResetTimer);
                marqueeResetTimer = null;
            }

            // Langsung render semua pesan ke marquee (tanpa delay)
            renderMarqueeMessages();
        };

        function updateBroadcastIndicator() {
            const text = document.getElementById('broadcast-text');
            if (text && activeMessages.length > 0) {
                text.innerText = `Live (${activeMessages.length})`;
                text.className = "text-[10px] text-blue-500 font-bold uppercase tracking-widest";
            } else if (text && activeMessages.length === 0) {
                text.innerText = "Live";
                text.className = "text-[10px] text-green-500 font-bold uppercase tracking-widest";
            }
        }

        function renderMarqueeMessages() {
            var marqueeEl = document.querySelector('.animate-marquee');
            if (!marqueeEl || activeMessages.length === 0) {
                return;
            }

            isDisplayingMarquee = true;

            // Gabungkan SEMUA pesan aktif jadi satu string marquee
            var combinedMessages = activeMessages.map(function (msg) {
                return `<span class="bg-yellow-400 text-blue-900 px-2 rounded-md font-black">INFO:</span> ${msg}`;
            }).join(' &nbsp;&nbsp; • &nbsp;&nbsp; ');

            // Tampilkan semua pesan + default marquee
            marqueeEl.innerHTML = combinedMessages + ' &nbsp;&nbsp; • &nbsp;&nbsp; ' + defaultMarquee;

            console.log("� Displaying", activeMessages.length, "messages combined");

            // Set timer untuk reset ke default setelah 45 detik tanpa pesan baru
            marqueeResetTimer = setTimeout(function () {
                console.log("🔄 Reset to default marquee");
                activeMessages = [];
                marqueeEl.innerHTML = defaultMarquee;
                isDisplayingMarquee = false;
                marqueeResetTimer = null;
                updateBroadcastIndicator();
            }, 45000);
        };

        function initSupabase() {
            if (typeof window.supabase !== 'undefined' && !window.supabaseClient) {
                try {
                    window.supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
                    console.log("✅ Supabase client created");
                    return true;
                } catch (e) {
                    console.error("❌ Supabase init error:", e);
                    return false;
                }
            }
            return !!window.supabaseClient;
        }
        // --- CEK STATUS TOKO ---
        async function syncStoreStatus() {
            if (!window.supabaseClient) return;

            // 1. Ambil status terakhir dari Database
            const { data } = await window.supabaseClient
                .from('broadcast_notifications')
                .select('message')
                .eq('title', 'SYSTEM_STORE_STATUS')
                .order('id', { ascending: false })
                .limit(1);

            if (data && data.length > 0) {
                const status = data[0].message; // 'OPEN' atau 'CLOSED'

                // Update Variabel Global
                window.isStoreOpen = (status === 'OPEN');

                // Update UI Indikator (Banner Marquee / Badge)
                updateStoreVisuals();
            }
        }

        function updateStoreVisuals() {
            const statusBadge = document.getElementById('store-status-badge');

            if (!window.isStoreOpen) {
                // JIKA TUTUP
                if (statusBadge) {
                    statusBadge.classList.remove('hidden');
                    statusBadge.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> <span class="text-[9px] font-bold text-red-500 ml-1">TUTUP</span>';
                }
                showToast("🔒 Toko Sedang Tutup");
            } else {
                // JIKA BUKA
                if (statusBadge) statusBadge.classList.add('hidden');
            }
        }

        // Panggil fungsi ini saat inisialisasi
        setTimeout(syncStoreStatus, 2000); // Tunggu sebentar setelah load

        function initMarqueeChannel() {
            if (!window.supabaseClient) {
                console.log("⚠️ Supabase client not ready");
                initSupabase();
            }

            if (!window.marqueeChannel && window.supabaseClient) {
                try {
                    console.log("📡 Subscribing to announcements table...");

                    // Subscribe ke perubahan di tabel announcements
                    window.marqueeChannel = window.supabaseClient
                        .channel('announcements-channel')
                        .on(
                            'postgres_changes',
                            {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'announcements'
                            },
                            function (payload) {
                                console.log("📨 New announcement from database:", payload);
                                if (payload.new && payload.new.message) {
                                    const message = payload.new.message;
                                    const timestamp = payload.new.timestamp || Date.now();
                                    console.log("� Processing message:", message, "timestamp:", timestamp);
                                    window.displayMarqueeMessage(message, timestamp);
                                } else {
                                    console.warn("⚠️ Invalid payload structure:", payload);
                                }
                            }
                        )
                        .subscribe(function (status, err) {
                            console.log("📡 Channel status:", status);

                            const indicator = document.getElementById('broadcast-indicator');
                            const text = document.getElementById('broadcast-text');

                            if (status === 'SUBSCRIBED') {
                                console.log("✅ Subscribed to announcements table!");
                                if (indicator) {
                                    indicator.className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
                                }
                                if (text) {
                                    text.innerText = "Live";
                                    text.className = "text-[10px] text-green-500 font-bold uppercase tracking-widest";
                                }
                            } else if (status === 'CHANNEL_ERROR') {
                                console.error("❌ Channel error:", err);
                                if (indicator) {
                                    indicator.className = "w-2 h-2 bg-red-500 rounded-full";
                                }
                                if (text) {
                                    text.innerText = "Error";
                                    text.className = "text-[10px] text-red-500 font-bold uppercase tracking-widest";
                                }
                            } else if (status === 'TIMED_OUT') {
                                console.error("❌ Channel timeout");
                                if (indicator) {
                                    indicator.className = "w-2 h-2 bg-orange-500 rounded-full";
                                }
                                if (text) {
                                    text.innerText = "Timeout";
                                    text.className = "text-[10px] text-orange-500 font-bold uppercase tracking-widest";
                                }
                            } else if (status === 'CLOSED') {
                                console.warn("⚠️ Channel closed");
                                if (indicator) {
                                    indicator.className = "w-2 h-2 bg-gray-500 rounded-full";
                                }
                                if (text) {
                                    text.innerText = "Closed";
                                    text.className = "text-[10px] text-gray-500 font-bold uppercase tracking-widest";
                                }
                            }
                        });

                    return true;
                } catch (e) {
                    console.error("❌ Channel init error:", e);
                    return false;
                }
            }
            return !!window.marqueeChannel;
        }
        function initNotificationChannel() {
            if (!window.supabaseClient) return;

            // Hapus channel lama jika ada (untuk mencegah duplikasi listener)
            if (window.storeChannel) window.supabaseClient.removeChannel(window.storeChannel);

            // Buat Channel Baru
            window.storeChannel = window.supabaseClient
                .channel('public:broadcast_notifications_v2')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'broadcast_notifications' }, payload => {
                    const data = payload.new;
                    if (!data) return;

                    console.log("📡 SIGNAL DITERIMA:", data.title, data.message);

                    // === KASUS 1: STATUS TOKO BERUBAH (REALTIME) ===
                    if (data.title === 'SYSTEM_STORE_STATUS') {
                        // 1. Update Variable Global
                        window.isStoreOpen = (data.message === 'OPEN');

                        // 2. Paksa Update Tampilan (Badge) Detik Itu Juga
                        updateStoreVisuals();

                        // 3. Tampilkan Toast / Pop-up Sesuai Status
                        if (window.isStoreOpen) {
                            showToast("🔓 UPDATE: Toko Sudah BUKA! Silahkan pesan.");
                            // Getar pendek 2x tanda buka
                            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                        } else {
                            showToast("🔒 UPDATE: Toko TUTUP Sementara.");
                            // Getar panjang tanda tutup
                            if (navigator.vibrate) navigator.vibrate([500]);
                        }
                    }

                    // === KASUS 2: NOTIFIKASI DARI OWNER (PROMO DLL) ===
                    else {
                        // Refresh list notifikasi karena ada pesan baru
                        loadNotifications();

                        // Munculkan Toast Pesan
                        showToast("📩 Pesan Baru: " + data.title);
                        if (navigator.vibrate) navigator.vibrate(200);
                    }
                })
                .subscribe((status) => {
                    console.log("Status Koneksi Realtime:", status);
                });
        }
        // Polling system untuk marquee (lebih reliable daripada Realtime)
        window.lastAnnouncementId = 0;
        window.pollingInterval = null;

        async function initMarqueePolling() {
            if (!window.supabaseClient) {
                console.log("⚠️ Supabase client not ready");
                return false;
            }

            if (window.pollingInterval) {
                console.log("✅ Polling already running");
                return true;
            }

            // --- INITIAL FETCH: Get only the LATEST message ---
            // This prevents old messages from flooding the screen on startup
            if (window.lastAnnouncementId === 0) {
                try {
                    const { data, error } = await window.supabaseClient
                        .from('announcements')
                        .select('*')
                        .order('id', { ascending: false })
                        .limit(1);

                    if (data && data.length > 0) {
                        const latest = data[0];
                        console.log("🏁 Initial Marquee:", latest.message);
                        window.displayMarqueeMessage(latest.message, latest.timestamp);
                        window.lastAnnouncementId = latest.id;
                    }
                } catch (e) {
                    console.error("❌ Initial fetch error:", e);
                }
            }

            console.log("🔄 Starting marquee polling every 2 seconds...");

            // Update indicator
            const indicator = document.getElementById('broadcast-indicator');
            const text = document.getElementById('broadcast-text');
            if (indicator) {
                indicator.className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
            }
            if (text) {
                text.innerText = "Live";
                text.className = "text-[10px] text-green-500 font-bold uppercase tracking-widest";
            }

            window.pollingInterval = setInterval(async function () {
                if (!window.supabaseClient) return;

                try {
                    const { data, error } = await window.supabaseClient
                        .from('announcements')
                        .select('*')
                        .gt('id', window.lastAnnouncementId)
                        .order('timestamp', { ascending: true })
                        .limit(10);

                    if (error) {
                        console.error("❌ Polling error:", error);
                        return;
                    }

                    if (data && data.length > 0) {
                        console.log("📬 Polling found", data.length, "new messages");
                        data.forEach(function (row) {
                            console.log("📩 Processing message:", row.message, "timestamp:", row.timestamp);
                            window.displayMarqueeMessage(row.message, row.timestamp);
                            window.lastAnnouncementId = Math.max(window.lastAnnouncementId, row.id);
                        });
                    }
                } catch (e) {
                    console.error("❌ Polling exception:", e);
                }
            }, 1000);

            return true;
        }

        var initInterval = setInterval(function () {
            if (initSupabase() && initMarqueePolling()) {
                initNotificationChannel(); // Start listening for broadcasts
                clearInterval(initInterval);
                console.log("✅ Supabase & Polling Ready");
            }
        }, 1000);

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyBR_Er6zVysY-J-ht8PMpKRW0FJ69utN3w",
            authDomain: "folkpresso.firebaseapp.com",
            databaseURL: "https://folkpresso-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "folkpresso",
            storageBucket: "folkpresso.firebasestorage.app",
            messagingSenderId: "728120023418",
            appId: "1:728120023418:web:62c8b1271da8af8a67dec3",
            measurementId: "G-4VRF8TV2E1"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === GLOBAL VARS ===
        var currentUser = "Guest";
        var userPoints = 0;
        var userCaffeine = 0;
        var currentTierStatus = "";
        var cart = [];
        var isStoreOpen = true;
        var communityGoal = 0;

        // === AUTH HANDLER ===
        auth.onAuthStateChanged((user) => {
            const loginScreen = document.getElementById('login-screen');
            const mainApp = document.getElementById('main-app');

            if (user) {
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                }, 500);
                startFolkSync(user.uid);
            } else {
                loginScreen.classList.remove('hidden');
                loginScreen.style.opacity = '1';
                mainApp.classList.add('hidden');
            }
        });

        window.loginWithGoogle = function () {
            const btn = document.querySelector('button[onclick*="loginWithGoogle"]');
            const text = document.getElementById('login-text');
            if (btn) btn.classList.add('opacity-50', 'pointer-events-none');
            if (text) text.innerText = "Membuka Google...";

            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            provider.setCustomParameters({ prompt: 'select_account' });

            // Deteksi mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // Gunakan redirect untuk mobile, popup untuk desktop
            const loginMethod = isMobile ?
                auth.signInWithRedirect(provider) :
                auth.signInWithPopup(provider);

            if (isMobile) {
                console.log("📱 Mobile detected, using redirect...");
                return; // Redirect akan handle sendiri

                auth.signInWithRedirect(provider);
            }

            // Untuk desktop (popup)
            loginMethod
                .then((result) => {
                    console.log("✅ Login berhasil:", result.user.displayName);
                    const user = result.user;

                    // Inisialisasi user baru di Firestore
                    const userRef = db.collection("users").doc(user.uid);
                    userRef.get().then((doc) => {
                        if (!doc.exists) {
                            userRef.set({
                                username: user.displayName,
                                customName: user.displayName,
                                email: user.email,
                                photo: user.photoURL,
                                points: 0,
                                caffeine: 0,
                                nameChangeCount: 0,
                                lastQuestDate: "",
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    });
                })
                .catch((error) => {
                    console.error("❌ Login error:", error);
                    if (btn) btn.classList.remove('opacity-50', 'pointer-events-none');
                    if (text) text.innerText = "Masuk dengan Google";

                    if (error.code === 'auth/popup-closed-by-user') {
                        console.log("User menutup popup");
                    } else if (error.code === 'auth/popup-blocked') {
                        console.log("Popup diblokir, coba redirect...");
                        auth.signInWithRedirect(provider);
                    } else if (error.code === 'auth/unauthorized-domain') {
                        alert("Domain belum terdaftar di Firebase Console!");
                    } else {
                        alert("Login gagal: " + error.message);
                    }
                });
        };

        // Handle redirect result untuk mobile
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log("✅ Login redirect berhasil:", result.user.displayName);
                const user = result.user;

                // Inisialisasi user baru di Firestore
                const userRef = db.collection("users").doc(user.uid);
                userRef.get().then((doc) => {
                    if (!doc.exists) {
                        userRef.set({
                            username: user.displayName,
                            customName: user.displayName,
                            email: user.email,
                            photo: user.photoURL,
                            points: 0,
                            caffeine: 0,
                            nameChangeCount: 0,
                            lastQuestDate: "",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            }
        }).catch((error) => {
            console.error("❌ Redirect error:", error);
        });

        function startFolkSync(uid) {
            db.collection("users").doc(uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    currentUser = data.customName || data.username || "Friend";
                    userPoints = data.points || 0;
                    userCaffeine = data.caffeine || 0;

                    const nameDisplay = document.getElementById('home-username');
                    const pointsDisplay = document.getElementById('home-points');
                    const profilePhoto = document.getElementById('profile-photo-nav');

                    if (nameDisplay) nameDisplay.innerText = currentUser;
                    if (pointsDisplay) pointsDisplay.innerText = userPoints.toLocaleString();
                    if (profilePhoto && data.photo) profilePhoto.src = data.photo;

                    // Load address
                    var addressInput = document.getElementById('input-address');
                    var cartAddr = document.getElementById('cart-address-display');
                    if (data.address) {
                        window.userAddress = data.address;
                        if (addressInput) addressInput.value = data.address;
                        if (cartAddr) cartAddr.innerText = data.address;
                    }

                    // Update profile photo & name in profile page
                    var profilePhotoDisplay = document.getElementById('profile-photo-display');
                    var profileDisplayName = document.getElementById('profile-display-name');
                    if (profilePhotoDisplay && data.photo) profilePhotoDisplay.src = data.photo;
                    if (profileDisplayName) profileDisplayName.innerText = currentUser;

                    checkQuestStatus(data.lastQuestDate);
                    updateMemberUI();
                }
            });
        }

        function checkQuestStatus(lastDate) {
            const today = new Date().toDateString();
            const btn = document.getElementById('quest-card');
            const status = document.getElementById('quest-status');
            if (!btn) return;
            if (lastDate === today) {
                btn.classList.add('opacity-50');
                if (status) status.innerText = "Terklaim ✅";
            } else {
                btn.classList.remove('opacity-50');
                if (status) status.innerText = "Klaim +50 Poin";
            }
        }

        function updateMemberUI() {
            var card = document.getElementById('member-card');
            var tierName = document.getElementById('tier-name');
            var bar = document.getElementById('level-bar');
            var dispPoints = document.getElementById('display-points');
            var cafMg = document.getElementById('caffeine-mg');
            var cafBar = document.getElementById('caffeine-bar');

            if (!card || !tierName || !bar || !dispPoints) return;

            dispPoints.innerText = userPoints.toLocaleString();

            var oldTier = currentTierStatus;
            var newTier = "";

            if (userPoints > 5000) {
                card.className = "member-card-gold rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6";
                tierName.innerText = "GOLD MEMBER 👑";
                bar.style.width = "100%";
                newTier = "GOLD MEMBER 👑";
            } else if (userPoints > 1000) {
                card.className = "member-card-silver rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6";
                tierName.innerText = "SILVER MEMBER ⚔️";
                bar.style.width = (userPoints / 5000 * 100) + "%";
                newTier = "SILVER MEMBER ⚔️";
            } else {
                card.className = "member-card-bronze rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6";
                tierName.innerText = "BRONZE MEMBER";
                bar.style.width = (userPoints / 1000 * 100) + "%";
                newTier = "BRONZE MEMBER";
            }

            // Broadcast jika naik tier
            if (oldTier !== "" && oldTier !== newTier && window.supabaseClient) {
                const broadcastMsg = `👑 Selamat! ${currentUser} naik ke ${newTier}!`;
                const timestamp = Date.now();
                console.log("📤 Inserting tier announcement:", broadcastMsg, "at", timestamp);

                // HANYA insert ke database, biarkan Realtime yang handle display
                window.supabaseClient
                    .from('announcements')
                    .insert([{
                        message: broadcastMsg,
                        timestamp: timestamp
                    }])
                    .then(({ data, error }) => {
                        if (error) {
                            console.error("❌ Database insert error:", error);
                        } else {
                            console.log("✅ Tier announcement inserted");
                        }
                    });
            }

            currentTierStatus = newTier;

            if (cafMg && cafBar) {
                cafMg.innerHTML = userCaffeine + '<span class="text-xs text-slate-400">mg</span>';
                cafBar.style.height = Math.min((userCaffeine / 500) * 100, 100) + "%";
            }
        }

        var products = [
            { name: "Aren Coffee", price: 15000, cost: 9000, type: "signature", mg: 80, image: "img/gula aren.png" },
            { name: "Salted Caramel", price: 15000, cost: 9000, type: "signature", mg: 60, image: "img/salted.png" },
            { name: "Caramel Macchiato", price: 15000, cost: 9000, type: "signature", mg: 120, image: "img/maciato.png" },
            { name: "Spanish Coffee", price: 15000, cost: 9000, type: "classic", mg: 100, image: "img/spanish.png" },
            { name: "Tiramisu", price: 15000, cost: 9000, type: "non-coffee", mg: 50, image: "img/tiramisu.png" },
            { name: "Hazelnut", price: 15000, cost: 9000, type: "non-coffee", mg: 60, image: "img/hazelnut.png" },
            { name: "Matcha Latte", price: 15000, cost: 9000, type: "non-coffee", mg: 40, image: "img/matcha.png" },
            { name: "Chocolate", price: 15000, cost: 9000, type: "non-coffee", mg: 10, image: "img/coklat.png" },
            { name: "Vanilla", price: 15000, cost: 9000, type: "non-coffee", mg: 50, image: "img/vanilla.png" }
        ];

        window.onload = function () {
            renderProducts(products);
            renderMenuGrid(products);
            loadPopularProducts();
            communityGoal = parseInt(localStorage.getItem('folkpresso_community_goal')) || 0;
            updateGoalUI();
        };

        function renderProducts(list) {
            var container = document.getElementById('product-list');
            if (!container) return;
            container.innerHTML = '';
            list.forEach(function (p) {
                var imgSrc = p.image || "img/gula aren.png";
                container.innerHTML += `
                <div class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] border border-slate-100 dark:border-slate-800 flex items-center gap-4">
                    <div class="w-16 h-16 shrink-0"><img src="${imgSrc}" class="w-full h-full object-cover rounded-2xl shadow-sm bg-slate-50"></div>
                    <div class="flex-1 min-w-0"><h4 class="font-bold text-sm dark:text-white truncate">${p.name}</h4><p class="text-blue-600 dark:text-blue-400 font-black text-xs">Rp ${p.price.toLocaleString()}</p></div>
                    <button onclick="addToCart('${p.name}', ${p.price}, ${p.mg}, ${p.cost})" class="bg-blue-900 dark:bg-blue-600 text-white w-10 h-10 rounded-xl font-bold shrink-0 shadow-lg active:scale-90 transition-transform">+</button>
                </div>`;
            });
        }

        window.addToCart = function (name, price, mg, cost) {
            // --- TAMBAHAN BLOKIR TOKO TUTUP ---
            if (!window.isStoreOpen) {
                showToast("⛔ Maaf, Toko Sedang Tutup!");
                // Mainkan efek getar jika di HP
                if (navigator.vibrate) navigator.vibrate(200);
                return; // Stop proses, jangan masukkan ke keranjang
            }
            // ----------------------------------

            var item = cart.find(i => i.name === name);
            if (item) item.quantity++; else cart.push({ name, price, mg, cost, quantity: 1 });
            showToast(name + " ditambahkan!");
            renderCart();
        };
        function renderCart() {
            var list = document.getElementById('cart-items');
            if (!list) return;
            var total = 0;
            list.innerHTML = cart.length ? '' : '<p class="text-center text-slate-400 text-xs py-10 italic">Keranjang kosong...</p>';
            cart.forEach((item, index) => {
                total += item.price * item.quantity;
                list.innerHTML += `
                <div class="bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4 mb-3">
                    <div class="flex-1"><h4 class="font-extrabold text-sm dark:text-white">${item.name}</h4><p class="text-blue-600 dark:text-blue-400 text-xs">Rp ${(item.price * item.quantity).toLocaleString()}</p></div>
                    <div class="flex items-center bg-slate-50 dark:bg-slate-800 p-1.5 rounded-2xl">
                        <button onclick="updateQty(${index}, -1)" class="w-8 h-8 bg-white dark:bg-slate-700 text-slate-600 dark:text-white rounded-xl font-bold">-</button>
                        <span class="px-4 text-sm font-black dark:text-white">${item.quantity}</span>
                        <button onclick="updateQty(${index}, 1)" class="w-8 h-8 bg-blue-900 dark:bg-blue-600 text-white rounded-xl font-bold">+</button>
                    </div>
                </div>`;
            });
            const totalEl = document.getElementById('cart-total');
            if (totalEl) totalEl.innerText = 'Rp ' + total.toLocaleString();
        }

        window.updateQty = function (i, d) {
            cart[i].quantity += d;
            if (cart[i].quantity < 1) cart.splice(i, 1);
            renderCart();
        };

        // --- MIDTRANS SNAP PAYMENT ---
        var MIDTRANS_SERVER_KEY = 'Mid-server-JWBir0vEHwL6X-vc7ftNa79H';

        window.openPayment = function () {
            if (!cart.length) return showToast("Keranjang kosong!");

            var totalOrder = cart.reduce(function (a, b) { return a + (b.price * b.quantity); }, 0);
            var orderId = 'KOPIKU-' + Date.now();

            var itemDetails = cart.map(function (item) {
                return {
                    id: item.name.replace(/\s+/g, '-').toLowerCase(),
                    price: item.price,
                    quantity: item.quantity,
                    name: item.name
                };
            });

            var transactionData = {
                transaction_details: {
                    order_id: orderId,
                    gross_amount: totalOrder
                },
                item_details: itemDetails,
                customer_details: {
                    first_name: currentUser || 'Guest',
                    email: (auth.currentUser && auth.currentUser.email) || 'guest@kopiku.app',
                    shipping_address: {
                        address: window.userAddress || '-'
                    }
                },
                enabled_payments: ['gopay', 'shopeepay', 'other_qris', 'dana']
            };

            showToast('⏳ Memproses pembayaran...');

            // Gunakan CORS Proxy untuk bypass blokir browser di localhost
            var targetUrl = 'https://app.sandbox.midtrans.com/snap/v1/transactions';
            var proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

            fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(MIDTRANS_SERVER_KEY + ':')
                },
                body: JSON.stringify(transactionData)
            })
                .then(function (res) {
                    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                    return res.json();
                })
                .then(function (data) {
                    if (data.token) {
                        console.log('✅ Snap Token:', data.token);
                        window.snap.pay(data.token, {
                            onSuccess: function (result) {
                                console.log('✅ Midtrans Success:', result);
                                var method = result.payment_type || 'midtrans';
                                if (method === 'other_qris') method = 'QRIS';
                                handlePaymentSuccess(method);
                            },
                            onPending: function (result) {
                                console.log('⏳ Midtrans Pending:', result);
                                showToast('⏳ Pembayaran pending...');
                            },
                            onError: function (result) {
                                console.error('❌ Midtrans Error:', result);
                                showToast('❌ Pembayaran gagal!');
                            },
                            onClose: function () {
                                console.log('🚪 Snap popup ditutup');
                            }
                        });
                    } else if (data.redirect_url) {
                        window.open(data.redirect_url, '_blank');
                    } else {
                        console.error('Midtrans response:', data);
                        showToast('❌ Gagal transaksi: ' + (data.error_messages ? data.error_messages.join(', ') : 'Unknown error'));
                    }
                })
                .catch(function (err) {
                    console.error('Midtrans fetch error:', err);
                    // Fallback Simulation UI
                    // Jika fetch gagal (CORS), buka modal simulasi agar user tetap bisa memilih metode
                    openSimulationModal();
                });
        };

        function handlePaymentSuccess(method) {
            const trackModal = document.getElementById('tracking-modal');
            const brewState = document.getElementById('brew-state');
            const finishState = document.getElementById('finish-state');
            const animBar = document.getElementById('anim-bar');

            if (trackModal && brewState && finishState && animBar) {
                trackModal.classList.remove('hidden');
                brewState.classList.remove('hidden');
                finishState.classList.add('hidden');
                animBar.style.width = "0%";

                submitTransaction(method);

                // Add notification
                var orderItems = cart.map(function (item) { return item.quantity + 'x ' + item.name; }).join(', ');
                addNotification('☕ Pesanan berhasil!', orderItems + ' via ' + method);

                setTimeout(() => {
                    animBar.style.width = "100%";
                    setTimeout(() => {
                        brewState.classList.add('hidden');
                        finishState.classList.remove('hidden');
                    }, 500);
                }, 3000);
            } else {
                submitTransaction(method);
                var orderItems = cart.map(function (item) { return item.quantity + 'x ' + item.name; }).join(', ');
                addNotification('☕ Pesanan berhasil!', orderItems + ' via ' + method);
                showToast('✅ Pembayaran berhasil via ' + method + '!');
                cart = [];
                renderCart();
                showPage('menu');
            }
        }

        window.closePaymentModal = function () { };
        window.processPayment = function (method) { handlePaymentSuccess(method); };

        async function submitTransaction(method) {
            const user = auth.currentUser;
            if (!user) return;

            let totalOrder = cart.reduce((a, b) => a + (b.price * b.quantity), 0);
            let totalCaffeine = cart.reduce((a, b) => a + (b.mg * b.quantity), 0);
            let totalCups = cart.reduce((a, b) => a + b.quantity, 0);

            communityGoal += totalCups;
            localStorage.setItem('folkpresso_community_goal', communityGoal);
            updateGoalUI();

            // Update Firestore (poin & caffeine)
            const userRef = db.collection("users").doc(user.uid);
            userRef.update({
                points: firebase.firestore.FieldValue.increment(Math.floor(totalOrder / 1000)),
                caffeine: firebase.firestore.FieldValue.increment(totalCaffeine)
            });

            // Kirim data transaksi ke Supabase
            const now = new Date();
            const dateStamp = now.toISOString().split('T')[0];
            const fullTimeStr = now.toLocaleDateString('id-ID') + " | " + now.toLocaleTimeString('id-ID');

            const payload = cart.map(item => ({
                date: dateStamp,
                full_time: fullTimeStr,
                name: item.name,
                user_id: user.uid,
                type: 'in',
                qty: item.quantity,
                unit_price: item.price,
                unit_cost: item.cost || 0,
                total: item.price * item.quantity,
                method: method,
                payment_status: 'success',
                location: window.userAddress || '-',
                netto: '-',
                notes: '-'
            }));

            if (window.supabaseClient) {
                try {
                    console.log("📤 Mengirim data ke Supabase...", payload);
                    const { data, error } = await window.supabaseClient
                        .from('transactions')
                        .insert(payload);

                    if (error) {
                        console.error("❌ Supabase Error:", error);
                        showToast("⚠️ Gagal sync database: " + error.message);
                    } else {
                        console.log("✅ Data berhasil dikirim ke Supabase!");
                    }
                } catch (err) {
                    console.error("❌ Error saat kirim data:", err);
                    showToast("⚠️ Error koneksi: " + err.message);
                }
            } else {
                console.warn("⚠️ Supabase client belum siap, data hanya tersimpan lokal");
                showToast("⚠️ Mode offline - data tersimpan lokal");
            }

            // Broadcast pesan ke database
            if (window.supabaseClient) {
                const orderDetails = cart.map(item => item.quantity + "x " + item.name).join(", ");
                const broadcastMsg = `☕ ${currentUser} baru saja memesan ${orderDetails} via ${method}!`;
                const timestamp = Date.now();
                console.log("📤 Inserting to database:", broadcastMsg, "at", timestamp);

                // HANYA insert ke database, biarkan Realtime yang handle display
                // Ini memastikan semua user (termasuk yang order) melihat pesan via Realtime
                window.supabaseClient
                    .from('announcements')
                    .insert([{
                        message: broadcastMsg,
                        timestamp: timestamp
                    }])
                    .then(({ data, error }) => {
                        if (error) {
                            console.error("❌ Database insert error:", error);
                        } else {
                            console.log("✅ Announcement inserted to database");
                        }
                    });
            } else {
                console.warn("⚠️ Supabase client not available");
            }
        }

        window.finishOrder = function () {
            document.getElementById('tracking-modal').classList.add('hidden');
            cart = [];
            renderCart();
            showPage('menu');
            showToast("Pesanan selesai! Poin bertambah.");
        };

        window.showPage = function (id) {
            document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(id + '-page');
            if (target) target.classList.add('active');

            document.querySelectorAll('nav button').forEach(b => {
                b.className = "flex flex-col items-center text-slate-400";
            });
            const btn = document.getElementById('btn-' + id);
            if (btn) btn.className = "flex flex-col items-center text-blue-900 dark:text-blue-400";

            if (id === 'cart') {
                renderCart();
                var cartAddr = document.getElementById('cart-address-display');
                if (cartAddr && window.userAddress) cartAddr.innerText = window.userAddress;
            }
            if (id === 'profile') {
                updateMemberUI();
                loadNotifications();
                loadOrderHistory();
            }
        };

        function showToast(msg) {
            var container = document.getElementById('toast-container');
            if (!container) return;
            var t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        function updateGoalUI() {
            var goalPercent = Math.min((communityGoal / 20) * 100, 100);
            const bar = document.getElementById('goal-bar');
            const txt = document.getElementById('goal-counter');
            if (bar) bar.style.width = goalPercent + "%";
            if (txt) txt.innerText = communityGoal + " / 20 Cups";
        }

        window.toggleDark = function () { document.documentElement.classList.toggle('dark'); };

        // Fungsi test marquee untuk debugging
        window.testMarquee = function () {
            console.log("🧪 Testing marquee with database...");
            console.log("Supabase client:", window.supabaseClient ? "Connected" : "Not connected");

            if (window.supabaseClient) {
                const timestamp = Date.now();
                const testMsg = `🧪 Test dari ${currentUser} - ${new Date(timestamp).toLocaleTimeString()}`;
                console.log("Inserting test message:", testMsg, "at", timestamp);

                // HANYA insert ke database, biarkan Realtime yang handle display
                window.supabaseClient
                    .from('announcements')
                    .insert([{
                        message: testMsg,
                        timestamp: timestamp
                    }])
                    .then(({ data, error }) => {
                        if (error) {
                            console.error("❌ Test insert error:", error);
                            alert("Error: " + error.message);
                        } else {
                            console.log("✅ Test message inserted");
                        }
                    });
            } else {
                console.error("❌ Supabase client not initialized");
                alert("Supabase client belum terhubung! Cek console untuk detail.");
            }
        };

        // Test multiple messages (simulasi 3 user order bersamaan)
        window.testMultipleMarquee = function () {
            console.log("🧪 Testing multiple messages...");

            if (!window.supabaseClient) {
                console.error("❌ Supabase client not initialized");
                alert("Supabase client belum terhubung!");
                return;
            }

            var baseTime = Date.now();

            // Simulasi 3 user order bersamaan dengan timestamp yang berbeda
            // User A order duluan (timestamp paling kecil)
            window.supabaseClient
                .from('announcements')
                .insert([{
                    message: "☕ User A memesan 2x Aren Coffee via Cash!",
                    timestamp: baseTime + 100
                }])
                .then(() => console.log("✅ User A message inserted"));

            // User B order kedua
            setTimeout(() => {
                window.supabaseClient
                    .from('announcements')
                    .insert([{
                        message: "☕ User B memesan 1x Salted Caramel via QRIS!",
                        timestamp: baseTime + 200
                    }])
                    .then(() => console.log("✅ User B message inserted"));
            }, 50);

            // User C order ketiga
            setTimeout(() => {
                window.supabaseClient
                    .from('announcements')
                    .insert([{
                        message: "⚔️ User C berhasil claim Daily Quest +50 poin!",
                        timestamp: baseTime + 300
                    }])
                    .then(() => console.log("✅ User C message inserted"));
            }, 100);

            console.log("✅ 3 messages will be inserted with timestamps");
            console.log("Expected order: A → B → C (sorted by timestamp)");
        };
        window.logout = function () {
            if (confirm("Yakin mau keluar?")) {
                auth.signOut().then(() => location.reload());
            }
        };

        window.claimQuest = function () {
            const user = auth.currentUser;
            if (!user) return;
            const userRef = db.collection("users").doc(user.uid);
            const today = new Date().toDateString();

            userRef.get().then((doc) => {
                if (doc.exists && doc.data().lastQuestDate === today) {
                    showToast("Sudah diklaim hari ini!");
                } else {
                    userRef.update({
                        points: firebase.firestore.FieldValue.increment(50),
                        lastQuestDate: today
                    }).then(() => {
                        showToast("🎉 +50 Poin Quest!");

                        // Broadcast pesan daily quest
                        if (window.supabaseClient) {
                            const broadcastMsg = `⚔️ ${currentUser} berhasil claim Daily Quest +50 poin!`;
                            const timestamp = Date.now();
                            console.log("📤 Inserting quest announcement:", broadcastMsg, "at", timestamp);

                            // HANYA insert ke database, biarkan Realtime yang handle display
                            window.supabaseClient
                                .from('announcements')
                                .insert([{
                                    message: broadcastMsg,
                                    timestamp: timestamp
                                }])
                                .then(({ data, error }) => {
                                    if (error) {
                                        console.error("❌ Database insert error:", error);
                                    } else {
                                        console.log("✅ Quest announcement inserted");
                                    }
                                });
                        }
                    });
                }
            });
        };

        window.updateCustomName = function () {
            const user = auth.currentUser;
            const name = document.getElementById('input-username').value;
            if (user && name) {
                db.collection("users").doc(user.uid).update({ customName: name });
                showToast("Nama diupdate!");
            }
        };

        window.mysteryBrew = function () {
            var random = products[Math.floor(Math.random() * products.length)];
            window.addToCart(random.name, random.price, random.mg, random.cost);
            showToast("✨ " + random.name + " terpilih!");
        };

        // === MENU GRID RENDERING ===
        var currentMenuFilter = 'all';

        function renderMenuGrid(list) {
            var grid = document.getElementById('menu-product-grid');
            if (!grid) return;
            grid.innerHTML = '';
            list.forEach(function (p) {
                var imgSrc = p.image || 'img/gula aren.png';
                grid.innerHTML += `
                <div class="menu-product-card" data-type="${p.type}">
                    <img src="${imgSrc}" class="w-full h-32 object-cover" onerror="this.src='img/gula aren.png'">
                    <div class="p-3">
                        <h4 class="font-bold text-sm dark:text-white truncate">${p.name}</h4>
                        <p class="text-blue-600 font-extrabold text-xs mt-1">Rp ${p.price.toLocaleString()}</p>
                        <button onclick="addToCart('${p.name}', ${p.price}, ${p.mg}, ${p.cost})"
                            class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white text-[10px] font-bold py-2 rounded-xl active:scale-95 transition-all">Add to Cart</button>
                    </div>
                </div>`;
            });
        }

        window.filterMenu = function (category) {
            currentMenuFilter = category;
            // Update tab styling
            var tabs = document.querySelectorAll('#menu-category-tabs .category-pill');
            tabs.forEach(function (t) { t.classList.remove('active'); });
            event.target.classList.add('active');

            if (category === 'all') {
                renderMenuGrid(products);
            } else {
                var filtered = products.filter(function (p) { return p.type === category; });
                renderMenuGrid(filtered);
            }
        };

        window.searchMenu = function (query) {
            var q = query.toLowerCase().trim();
            var base = currentMenuFilter === 'all' ? products : products.filter(function (p) { return p.type === currentMenuFilter; });
            if (!q) {
                renderMenuGrid(base);
                return;
            }
            var filtered = base.filter(function (p) { return p.name.toLowerCase().indexOf(q) !== -1; });
            renderMenuGrid(filtered);
        };

        // === SAVE ADDRESS ===
        window.userAddress = '';

        window.saveAddress = function () {
            var user = auth.currentUser;
            var addr = document.getElementById('input-address').value.trim();
            if (!user || !addr) { showToast('Masukkan alamat terlebih dahulu!'); return; }

            db.collection('users').doc(user.uid).update({ address: addr }).then(function () {
                window.userAddress = addr;
                var cartAddr = document.getElementById('cart-address-display');
                if (cartAddr) cartAddr.innerText = addr;
                showToast('📍 Alamat tersimpan!');
                addNotification('📍 Alamat diperbarui', addr);
            });
        };

        // === GPS ADDRESS: DETAIL MAKSIMAL (Jalan, Kampung, Kelurahan, Kecamatan) ===
        window.getGPSAddress = function () {
            var btn = document.getElementById('btn-gps');
            var status = document.getElementById('gps-status');
            var addrInput = document.getElementById('input-address');

            if (!navigator.geolocation) {
                showToast('❌ GPS tidak didukung browser ini');
                return;
            }

            if (btn) btn.innerHTML = '<span class="animate-spin">⌛</span> Mencari Detail...';
            if (status) {
                status.classList.remove('hidden');
                status.innerText = '📡 Menghubungkan satelit...';
            }

            // Opsi GPS dimaksimalkan untuk akurasi tinggi
            var options = {
                enableHighAccuracy: true,
                timeout: 20000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    var lat = pos.coords.latitude;
                    var lon = pos.coords.longitude;

                    if (status) status.innerText = 'Titik didapat. Mengurai alamat lengkap...';

                    // Fetch ke Nominatim
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`, {
                        headers: {
                            'Accept-Language': 'id-ID, id;q=0.9'
                        }
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.address) {
                                let a = data.address;
                                let parts = [];

                                // 1. NAMA JALAN (Cek berbagai variasi nama jalan di OSM)
                                let jalan = a.road || a.street || a.footway || a.path || a.track || a.pedestrian;
                                if (jalan) {
                                    // Tambah nomor rumah jika ada
                                    if (a.house_number) {
                                        parts.push(jalan + " No. " + a.house_number);
                                    } else {
                                        parts.push(jalan);
                                    }
                                } else {
                                    // Jika tidak ada nama jalan resmi, cek nama gedung/poi
                                    let poi = a.amenity || a.building || a.shop || a.office || a.leisure;
                                    if (poi) parts.push(poi);
                                }

                                // 2. LINGKUNGAN / RT / RW / DUSUN
                                // Di Indonesia, RT/RW sering masuk ke field 'neighbourhood', 'hamlet', atau 'quarter'
                                let lingkungan = a.neighbourhood || a.hamlet || a.quarter || a.residential;
                                if (lingkungan) parts.push(lingkungan);

                                // 3. KELURAHAN / DESA
                                // Prioritas: village (desa) -> suburb (kelurahan kota)
                                let kelurahan = a.village || a.town_hall;
                                if (!kelurahan) {
                                    // Kadang 'suburb' dipakai untuk kelurahan, kadang kecamatan. 
                                    // Kita ambil jika belum ada kecamatan yang terdeteksi nanti.
                                    if (a.suburb && !a.city_district && !a.county) {
                                        kelurahan = a.suburb;
                                    }
                                }
                                if (kelurahan) parts.push("Kel/Desa " + kelurahan);

                                // 4. KECAMATAN
                                // Di OSM Indonesia, Kecamatan sering masuk ke 'county', 'city_district', atau 'district'
                                let kecamatan = a.city_district || a.district || a.county || a.municipality;
                                // Filter agar kecamatan tidak duplikat dengan nama kota
                                let kota = a.city || a.town || a.regency;

                                if (kecamatan && kecamatan !== kota && kecamatan !== kelurahan) {
                                    parts.push("Kec. " + kecamatan);
                                } else if (a.suburb && !kelurahan) {
                                    // Fallback: jika suburb ada tapi tidak dipakai sebagai kelurahan
                                    parts.push("Kec. " + a.suburb);
                                }

                                // 5. KOTA / KABUPATEN
                                if (kota) {
                                    // Cek apakah dia Kota atau Kabupaten
                                    if (a.state_district) {
                                        // Jika ada state_district biasanya itu nama Kabupaten
                                        parts.push(kota);
                                    } else {
                                        parts.push(kota);
                                    }
                                }

                                // 6. KODEPOS (Opsional, agar terlihat pro)
                                if (a.postcode) parts.push(a.postcode);

                                // GABUNGKAN
                                // Filter duplikat (misal nama jalan sama dengan nama dusun)
                                let uniqueParts = [...new Set(parts)];
                                var finalAddr = uniqueParts.join(", ");

                                // Jika kosong total (jarang terjadi), pakai display_name bawaan
                                if (finalAddr.length < 5) finalAddr = data.display_name;

                                // OUTPUT
                                if (addrInput) addrInput.value = finalAddr;
                                window.userAddress = finalAddr;

                                // Simpan ke DB
                                if (typeof auth !== 'undefined' && auth.currentUser) {
                                    db.collection('users').doc(auth.currentUser.uid).update({
                                        address: finalAddr
                                    });
                                }

                                if (status) status.innerText = '✅ Terdeteksi: ' + finalAddr;
                                showToast('📍 Alamat Detail Ditemukan!');
                            } else {
                                // Fallback Koordinat
                                var backup = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                                if (addrInput) addrInput.value = backup;
                                window.userAddress = backup;
                                if (status) status.innerText = '⚠️ Nama jalan tidak terdaftar di peta.';
                            }
                            if (btn) btn.innerHTML = '📡 Update Lokasi';
                        })
                        .catch(err => {
                            console.error(err);
                            if (btn) btn.innerHTML = '📡 Gunakan GPS';
                            if (status) status.innerText = '⚠️ Gagal mengambil detail alamat.';
                        });
                },
                function (err) {
                    if (btn) btn.innerHTML = '📡 Gunakan GPS';
                    let errorMsg = 'Gagal melacak lokasi.';
                    if (err.code === 1) errorMsg = '❌ Izin GPS ditolak.';
                    if (err.code === 3) errorMsg = '❌ Waktu habis (Timeout).';
                    showToast(errorMsg);
                    if (status) status.innerText = errorMsg;
                },
                options
            );
        };

        // === NOTIFICATIONS ===
        var notifications = JSON.parse(localStorage.getItem('kopiku_notifs') || '[]');

        function addNotification(title, message) {
            var notif = {
                title: title,
                message: message,
                time: Date.now()
            };
            notifications.unshift(notif);
            if (notifications.length > 20) notifications.pop();
            localStorage.setItem('kopiku_notifs', JSON.stringify(notifications));
        }
        async function loadNotifications() {
            var container = document.getElementById('notif-list');
            if (!container) return;

            container.innerHTML = '<div class="flex justify-center py-4"><span class="animate-spin text-blue-500">⌛</span></div>';

            var broadcasts = [];
            if (window.supabaseClient) {
                try {
                    const { data } = await window.supabaseClient
                        .from('broadcast_notifications')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(20);
                    if (data) broadcasts = data;
                } catch (e) { console.error("Notif fetch error:", e); }
            }

            var all = [];

            broadcasts.forEach(n => {
                // --- FILTER: JANGAN TAMPILKAN STATUS TOKO DI LIST ---
                if (n.title === 'SYSTEM_STORE_STATUS') return; // Skip data ini
                // ----------------------------------------------------

                all.push({
                    title: "📢 " + n.title,
                    message: n.message,
                    time: new Date(n.created_at).getTime()
                });
            });

            // Limit tampilan
            all = all.slice(0, 30);

            if (all.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Belum ada notifikasi</p>';
                return;
            }

            container.innerHTML = '';
            all.forEach(function (n) {
                const diff = Date.now() - n.time;
                let timeStr = "";
                if (diff < 60000) timeStr = "Baru saja";
                else if (diff < 3600000) timeStr = Math.floor(diff / 60000) + " menit lalu";
                else if (diff < 86400000) timeStr = Math.floor(diff / 3600000) + " jam lalu";
                else timeStr = new Date(n.time).toLocaleDateString('id-ID');

                container.innerHTML += `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm relative overflow-hidden group mb-2 transition-all">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-slate-800 dark:text-white text-sm uppercase tracking-wider">${n.title}</h4>
                        <span class="text-[10px] text-slate-400 italic">${timeStr}</span>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-300 leading-relaxed font-medium">${n.message}</p>
                </div>`;
            });
        }
        function getTimeAgo(timestamp) {
            var diff = Date.now() - timestamp;
            var mins = Math.floor(diff / 60000);
            if (mins < 1) return 'Baru saja';
            if (mins < 60) return mins + ' menit lalu';
            var hours = Math.floor(mins / 60);
            if (hours < 24) return hours + ' jam lalu';
            var days = Math.floor(hours / 24);
            return days + ' hari lalu';
        }

        // === ORDER HISTORY ===
        window.loadOrderHistory = async function () {
            var container = document.getElementById('order-history-list');
            if (!container) return;
            container.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Memuat...</p>';

            if (!window.supabaseClient) {
                container.innerHTML = '<p class="text-xs text-red-400 italic text-center py-4">Database belum terhubung</p>';
                return;
            }

            var user = auth.currentUser;
            if (!user) {
                container.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Silakan login</p>';
                return;
            }

            try {
                var { data, error } = await window.supabaseClient
                    .from('transactions') // Pastikan nama tabel benar
                    .select('date, full_time, name, qty, total, method, payment_status, user_id') // Select specific fields for clarity
                    .eq('user_id', user.uid)
                    .order('id', { ascending: false })
                    .limit(20);

                if (error) {
                    container.innerHTML = '<p class="text-xs text-red-400 italic text-center py-4">Gagal memuat: ' + error.message + '</p>';
                    return;
                }

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-xs text-slate-400 italic text-center py-4">Belum ada riwayat pesanan</p>';
                    return;
                }

                container.innerHTML = '';
                data.forEach(function (tx) {
                    container.innerHTML += `
                    <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl">
                        <div class="flex justify-between items-start">
                            <h5 class="font-bold text-xs dark:text-white">${tx.name} (${tx.qty}x)</h5>
                            <span class="text-[10px] text-slate-400">${tx.full_time || tx.date}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-[11px] text-blue-600 font-bold">Rp ${(tx.total || 0).toLocaleString()}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${tx.payment_status === 'success' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}">${tx.method}</span>
                        </div>
                    </div>`;
                });
            } catch (e) {
                container.innerHTML = '<p class="text-xs text-red-400 italic text-center py-4">Error: ' + e.message + '</p>';
            }
        };

        // === POPULAR PRODUCTS FROM ORDER DATA ===
        window.loadPopularProducts = async function () {
            if (!window.supabaseClient) {
                // Default: show first 3 products
                renderProducts(products.slice(0, 3));
                return;
            }

            try {
                var { data, error } = await window.supabaseClient
                    .from('transactions')
                    .select('name, qty');

                if (error || !data || data.length === 0) {
                    renderProducts(products.slice(0, 3));
                    return;
                }

                // Count total qty per product name
                var countMap = {};
                data.forEach(function (tx) {
                    if (!countMap[tx.name]) countMap[tx.name] = 0;
                    countMap[tx.name] += (tx.qty || 1);
                });

                // Sort products by order count
                var sorted = products.slice().sort(function (a, b) {
                    return (countMap[b.name] || 0) - (countMap[a.name] || 0);
                });

                // Take top 3
                var top3 = sorted.slice(0, 3);
                renderProducts(top3);
            } catch (e) {
                console.error('Error loading popular:', e);
                renderProducts(products.slice(0, 3));
            }
        };
    </script>
    <!-- ===== SIMULATION PAYMENT MODAL ===== -->
    <div id="simulation-payment-modal"
        class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden items-end sm:items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl slide-up">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-lg font-extrabold text-slate-800 dark:text-white">Pilih Pembayaran</h3>
                    <p class="text-xs text-slate-500">Mode Simulasi (CORS Fallback)</p>
                </div>
                <button onclick="closeSimulationModal()"
                    class="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 font-bold hover:bg-slate-200">✕</button>
            </div>

            <div class="space-y-3">
                <button onclick="handlePaymentSuccess('GoPay')"
                    class="w-full flex items-center justify-between p-4 bg-sky-50 hover:bg-sky-100 border border-sky-100 rounded-xl transition-all">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">🟢</span>
                        <span class="font-bold text-slate-700">GoPay</span>
                    </div>
                    <span class="text-xs font-bold text-sky-600 bg-sky-100 px-2 py-1 rounded-lg">Pilih</span>
                </button>

                <button onclick="handlePaymentSuccess('ShopeePay')"
                    class="w-full flex items-center justify-between p-4 bg-orange-50 hover:bg-orange-100 border border-orange-100 rounded-xl transition-all">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">🟧</span>
                        <span class="font-bold text-slate-700">ShopeePay</span>
                    </div>
                    <span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-lg">Pilih</span>
                </button>

                <button onclick="handlePaymentSuccess('Dana')"
                    class="w-full flex items-center justify-between p-4 bg-blue-50 hover:bg-blue-100 border border-blue-100 rounded-xl transition-all">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">🔵</span>
                        <span class="font-bold text-slate-700">Dana</span>
                    </div>
                    <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-lg">Pilih</span>
                </button>

                <button onclick="handlePaymentSuccess('QRIS')"
                    class="w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-xl transition-all">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">🔳</span>
                        <span class="font-bold text-slate-700">QRIS</span>
                    </div>
                    <span class="text-xs font-bold text-slate-600 bg-slate-200 px-2 py-1 rounded-lg">Pilih</span>
                </button>
            </div>

            <p class="text-[10px] text-slate-400 text-center mt-6">
                *Simulasi ini muncul karena koneksi ke Midtrans API diblokir browser.
            </p>
        </div>
    </div>

    <script>
        function openSimulationModal() {
            document.getElementById('simulation-payment-modal').classList.remove('hidden');
            document.getElementById('simulation-payment-modal').classList.add('flex');
        }
        function closeSimulationModal() {
            document.getElementById('simulation-payment-modal').classList.add('hidden');
            document.getElementById('simulation-payment-modal').classList.remove('flex');
        }
    </script>
</body>

</html>