<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folkpresso | The Community Coffee</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/751/751621.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes brewBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .app-page { display: none; }
        .app-page.active { display: block; animation: slideUp 0.4s ease-out; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-nav { background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 20s linear infinite; }
        .anim-brew { animation: brewBounce 1s infinite ease-in-out; }
        .member-card-gold { background: linear-gradient(135deg, #FFD700, #B8860B); color: #FFF; }
        .member-card-silver { background: linear-gradient(135deg, #E0E0E0, #9E9E9E); color: #333; }
        .member-card-bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #FFF; }
        .grayscale-mode { filter: grayscale(100%); pointer-events: none; opacity: 0.6; }
        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 10001; pointer-events: none; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .toast { background: #1e3a8a; color: white; padding: 12px 24px; border-radius: 50px; margin-top: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s forwards; }
        
        /* Modal Layering */
        #payment-modal, #tracking-modal, #universal-popup { z-index: 9999; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 pb-32 dark:bg-slate-950 dark:text-white transition-colors duration-300 font-sans select-none">

    <div id="toast-container"></div>

    <div id="universal-popup" class="fixed inset-0 hidden items-center justify-center p-6 backdrop-blur-md bg-black/40">
        <div class="bg-white dark:bg-slate-900 w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl transform scale-50 opacity-0 transition-all duration-300" id="popup-content">
            <div id="popup-icon" class="text-5xl text-center mb-4">‚ú®</div>
            <h3 id="popup-title" class="text-xl font-black text-center text-blue-900 dark:text-white italic mb-2">Pemberitahuan</h3>
            <p id="popup-message" class="text-sm text-center text-slate-500 dark:text-slate-400 mb-6 font-medium">Pesan di sini...</p>
            <div id="popup-actions" class="w-full"></div>
        </div>
    </div>

    <div id="payment-modal" class="fixed inset-0 hidden flex items-center justify-center p-6 backdrop-blur-md bg-black/40">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-2xl font-black text-center text-blue-900 dark:text-white mb-6">Pilih Metode Pembayaran</h3>
            <div class="space-y-3">
                <button onclick="processPayment('Cash')" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform">üíµ Cash</button>
                <button onclick="processPayment('QRIS')" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform">üì± QRIS</button>
                <button onclick="processPayment('Transfer')" class="w-full bg-purple-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:scale-105 active:scale-95 transition-transform">üè¶ Transfer</button>
                <button onclick="closePaymentModal()" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white py-4 rounded-2xl font-bold">Batal</button>
            </div>
        </div>
    </div>

    <div id="tracking-modal" class="fixed inset-0 hidden flex items-center justify-center p-6 backdrop-blur-md bg-black/40">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl text-center">
            <div id="brew-state">
                <div class="text-6xl mb-4 anim-brew">‚òï</div>
                <h3 id="track-title" class="text-2xl font-black text-blue-900 dark:text-white mb-2">Memproses...</h3>
                <p id="track-desc" class="text-sm text-slate-500 dark:text-slate-400 mb-6">Pesananmu sedang dibuat</p>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-3 rounded-full overflow-hidden">
                    <div id="anim-bar" class="h-full bg-blue-600 transition-all duration-[3000ms]" style="width: 0%"></div>
                </div>
            </div>
            <div id="finish-state" class="hidden flex-col items-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-2xl font-black text-green-600 mb-2">Pesanan Selesai!</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Terima kasih sudah order!</p>
                <button onclick="finishOrder()" class="w-full bg-blue-900 dark:bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">Oke!</button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-[5000] bg-gradient-to-br from-blue-700 to-blue-900 flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="mb-8 p-6 bg-white rounded-[2.5rem] shadow-2xl animate-bounce">
            <img src="https://cdn-icons-png.flaticon.com/512/751/751621.png" class="w-20 h-20">
        </div>
        <h1 class="text-5xl font-extrabold text-white mb-3 italic tracking-tight">Folkpresso</h1>
        <p class="text-blue-100 mb-12 text-center max-w-xs font-medium">Komunitas Kopi & Loyalty App.<br>Masuk untuk kumpulkan poin.</p>

        <button onclick="loginWithGoogle()" class="group w-full max-w-xs bg-white text-blue-900 font-bold py-4 px-6 rounded-2xl shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-4">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-6 h-6">
            <span id="login-text">Masuk dengan Google</span>
        </button>
        <p class="mt-10 text-xs text-blue-300/60 font-semibold tracking-widest uppercase">Copyright - Folkpresso</p>
    </div>

    <div id="main-app" class="hidden">
        <header class="glass-nav sticky top-0 z-[60]">
            <div class="px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-extrabold text-blue-900 dark:text-blue-400 tracking-tighter italic">FOLKPRESSO</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <div id="store-status-badge" class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <p class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-widest">Open Now</p>
                        </div>
                        <div id="broadcast-status" class="flex items-center gap-1.5">
                            <span id="broadcast-indicator" class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <p id="broadcast-text" class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-widest">Connecting...</p>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleDark()" class="bg-slate-100 dark:bg-slate-800 p-2.5 rounded-2xl">üåô</button>
                    <button onclick="window.showPage('admin')" class="bg-blue-100 dark:bg-blue-900/30 p-2.5 rounded-2xl text-blue-600 dark:text-blue-400">üìä</button>
                </div>
            </div>
            <div class="px-6 pb-4">
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest mb-1">
                    <span class="text-blue-900 dark:text-blue-300">Community Goal üéØ</span>
                    <span id="goal-counter" class="text-slate-400">0 / 20 Cups</span>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="goal-bar" class="h-full bg-blue-600 w-0 transition-all duration-1000"></div>
                </div>
            </div>
        </header>

        <main id="home-page" class="app-page active">
            <div class="px-6 mt-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="profile-photo-nav" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="w-10 h-10 rounded-full border-2 border-blue-500 object-cover">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Halo, Friend!</p>
                        <h2 id="home-username" class="text-sm font-black text-blue-900 dark:text-white truncate max-w-[120px]">Guest</h2>
                    </div>
                </div>
                <div onclick="window.showPage('profile')" class="bg-blue-100 dark:bg-slate-800 px-3 py-1 rounded-full flex items-center gap-1 cursor-pointer">
                    <span class="text-xs">‚≠ê</span>
                    <span id="home-points" class="text-xs font-bold text-blue-800 dark:text-blue-300">0</span>
                </div>
            </div>

            <div class="bg-blue-900 dark:bg-blue-950 py-2 mt-4 overflow-hidden border-y border-blue-800">
                <div class="animate-marquee text-xs font-bold text-blue-200 tracking-wide">
                    üî• "Aren Latte-nya juara!" &nbsp;&nbsp; ‚Ä¢ &nbsp;&nbsp; üéµ Now Playing: The 1975 &nbsp;&nbsp; ‚Ä¢ &nbsp;&nbsp; ‚òï Folkpresso Open!
                </div>
            </div>

            <div class="px-6 mt-6 grid grid-cols-2 gap-3">
                <div onclick="mysteryBrew()" class="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-[2rem] p-5 text-white shadow-lg active:scale-95 transition-transform">
                     <h4 class="font-black text-sm">Mystery Brew üé≤</h4>
                     <p class="text-[10px] opacity-80">Biarkan kami pilih!</p>
                </div>
                <div onclick="claimQuest()" id="quest-card" class="bg-gradient-to-br from-pink-500 to-orange-500 rounded-[2rem] p-5 text-white shadow-lg active:scale-95 transition-transform">
                    <h4 class="font-black text-sm">Daily Quest ‚öîÔ∏è</h4>
                    <p id="quest-status" class="text-[10px] opacity-80">Klaim +50 Poin</p>
                </div>
            </div>

            <div class="px-6 mt-8 pb-10 space-y-4" id="product-list"></div>
        </main>

        <main id="cart-page" class="app-page px-6 pt-8">
            <h2 class="text-2xl font-black text-blue-900 dark:text-blue-400 mb-6 italic text-center">Keranjang</h2>
            <div id="cart-items" class="space-y-3 min-h-[100px]"></div>
            <div class="mt-8 p-6 bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-xl border border-slate-100 dark:border-slate-800">
                <div class="flex justify-between items-center mb-4"><span class="font-bold text-slate-400 uppercase text-xs">Total</span><span id="cart-total" class="text-xl font-black text-blue-900 dark:text-white">Rp 0</span></div>
                <button onclick="window.openPayment()" class="w-full bg-blue-900 dark:bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">Checkout</button>
            </div>
        </main>

        <main id="profile-page" class="app-page p-6">
            <h3 class="text-xl font-black mb-6">Pengaturan Profil</h3>
            
            <div id="member-card" class="member-card-bronze rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6">
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-80">Status Member</p>
                    <h2 id="tier-name" class="text-2xl font-black mt-1">BRONZE MEMBER</h2>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold opacity-80">Total Poin</span>
                        <span id="display-points" class="text-xl font-black">0</span>
                    </div>
                    <div class="w-full bg-white/20 h-2 rounded-full overflow-hidden">
                        <div id="level-bar" class="h-full bg-white transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 mb-6">
                <h4 class="font-bold text-sm mb-4">‚ö° Caffeine Meter</h4>
                <div class="flex items-end gap-2 h-24">
                    <div class="flex-1 bg-slate-100 dark:bg-slate-800 rounded-t-xl relative overflow-hidden">
                        <div id="caffeine-bar" class="absolute bottom-0 w-full bg-orange-400 transition-all duration-1000" style="height: 0%"></div>
                    </div>
                    <div class="text-right">
                        <h5 id="caffeine-mg" class="text-2xl font-black text-orange-500">0<span class="text-xs text-slate-400">mg</span></h5>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-800">
                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nama Custom Kamu</label>
                <div class="flex gap-2 mt-2">
                    <input type="text" id="input-username" class="flex-1 bg-slate-100 dark:bg-slate-800 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-blue-500" placeholder="Masukkan nama...">
                    <button onclick="updateCustomName()" id="btn-save-name" class="bg-blue-600 text-white px-4 rounded-xl font-bold text-xs">Simpan</button>
                </div>
                <p id="name-change-info" class="text-[10px] text-slate-400 mt-2 italic">*Nama ini akan muncul di aplikasi</p>
            </div>

            <button onclick="logout()" class="w-full mt-8 bg-red-100 text-red-600 py-4 rounded-2xl font-bold">Keluar Akun</button>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 z-[80] glass-nav p-4 flex justify-around">
            <button onclick="showPage('home')" id="btn-home" class="flex flex-col items-center text-blue-900 dark:text-blue-400">üè†<span class="text-[10px] font-bold mt-1">Menu</span></button>
            <button onclick="showPage('cart')" id="btn-cart" class="flex flex-col items-center text-slate-400">üõí<span class="text-[10px] font-bold mt-1">Cart</span></button>
            <button onclick="showPage('profile')" id="btn-profile" class="flex flex-col items-center text-slate-400">üòé<span class="text-[10px] font-bold mt-1">Profile</span></button>
        </nav>
    </div>

    <script>
        // === SUPABASE CONFIG ===
        var SB_URL = "https://gfmvigkhflkqetbftttr.supabase.co";
        var SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmbXZpZ2toZmxrcWV0YmZ0dHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTQ3NDAsImV4cCI6MjA4NTYzMDc0MH0.dGq7S_3y2nG8Nrl_ZpzLVuncoedp2rlIzb2u4cZ44Fg";
        var defaultMarquee = `üî• "Aren Latte-nya juara!" - Andi &nbsp;&nbsp; ‚Ä¢ &nbsp;&nbsp; üéµ Now Playing: The 1975 &nbsp;&nbsp; ‚Ä¢ &nbsp;&nbsp; ‚òï Folkpresso Open!`;
        var marqueeTimer;
        var marqueeQueue = [];
        var isDisplayingMarquee = false;

        window.displayMarqueeMessage = function(message) {
            console.log("üì¢ displayMarqueeMessage called:", message);
            var marqueeEl = document.querySelector('.animate-marquee');
            
            if (!marqueeEl) {
                console.error("‚ùå Marquee element not found!");
                return;
            }
            
            console.log("‚úÖ Marquee element found, adding to queue");
            // Tambahkan pesan ke antrian
            marqueeQueue.push(message);
            console.log("üìã Queue length:", marqueeQueue.length);
            
            // Update indicator
            updateBroadcastIndicator();
            
            // Jika tidak sedang menampilkan, mulai proses
            if (!isDisplayingMarquee) {
                console.log("‚ñ∂Ô∏è Starting queue process");
                processMarqueeQueue();
            } else {
                console.log("‚è∏Ô∏è Already displaying, message queued");
            }
        };

        function updateBroadcastIndicator() {
            const text = document.getElementById('broadcast-text');
            if (text && marqueeQueue.length > 0) {
                text.innerText = `Queue: ${marqueeQueue.length}`;
                text.className = "text-[10px] text-blue-500 font-bold uppercase tracking-widest";
            } else if (text && marqueeQueue.length === 0 && window.marqueeChannel) {
                text.innerText = "Live";
                text.className = "text-[10px] text-green-500 font-bold uppercase tracking-widest";
            }
        }

        function processMarqueeQueue() {
            var marqueeEl = document.querySelector('.animate-marquee');
            if (!marqueeEl || marqueeQueue.length === 0) {
                console.log("‚èπÔ∏è Queue empty or element not found");
                isDisplayingMarquee = false;
                updateBroadcastIndicator();
                return;
            }
            
            isDisplayingMarquee = true;
            
            // Ambil pesan pertama dari antrian
            var message = marqueeQueue.shift();
            console.log("üì∫ Displaying message:", message);
            console.log("üìã Remaining in queue:", marqueeQueue.length);
            
            // Update indicator
            updateBroadcastIndicator();
            
            // Tampilkan pesan
            marqueeEl.innerHTML = `<span class="bg-yellow-400 text-blue-900 px-2 rounded-md font-black">INFO:</span> ${message} &nbsp;&nbsp; ‚Ä¢ &nbsp;&nbsp; ${defaultMarquee}`;
            
            // Setelah 5 detik, proses pesan berikutnya
            setTimeout(function() {
                console.log("‚è≠Ô∏è Message timeout, checking queue...");
                if (marqueeQueue.length > 0) {
                    console.log("üìã More messages in queue:", marqueeQueue.length);
                    processMarqueeQueue();
                } else {
                    // Jika tidak ada lagi, kembali ke default setelah 3 detik
                    console.log("‚è≥ No more messages, resetting in 3s...");
                    setTimeout(function() {
                        marqueeEl.innerHTML = defaultMarquee;
                        isDisplayingMarquee = false;
                        updateBroadcastIndicator();
                        console.log("üîÑ Reset to default marquee");
                    }, 3000);
                }
            }, 5000);
        };

        function initSupabase() {
            if (typeof window.supabase !== 'undefined' && !window.supabaseClient) {
                try {
                    window.supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
                    console.log("‚úÖ Supabase client created");
                    return true;
                } catch(e) { 
                    console.error("‚ùå Supabase init error:", e);
                    return false; 
                }
            }
            return !!window.supabaseClient;
        }

        function initMarqueeChannel() {
            if (!window.supabaseClient) {
                console.log("‚ö†Ô∏è Supabase client not ready");
                initSupabase();
            }
            
            if (!window.marqueeChannel && window.supabaseClient) {
                try {
                    console.log("üì° Creating marquee channel...");
                    window.marqueeChannel = window.supabaseClient.channel('folkpresso-marquee');
                    
                    window.marqueeChannel.on('broadcast', { event: 'announcement' }, function(payload) {
                        console.log("üì® Received broadcast:", payload);
                        if (payload.payload && payload.payload.message) {
                            console.log("üì¢ Processing message:", payload.payload.message);
                            window.displayMarqueeMessage(payload.payload.message);
                        } else {
                            console.warn("‚ö†Ô∏è Invalid payload structure:", payload);
                        }
                    });
                    
                    window.marqueeChannel.subscribe(function(status) {
                        console.log("üì° Channel status:", status);
                        
                        const indicator = document.getElementById('broadcast-indicator');
                        const text = document.getElementById('broadcast-text');
                        
                        if (status === 'SUBSCRIBED') {
                            console.log("‚úÖ Marquee channel subscribed!");
                            if (indicator) {
                                indicator.className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
                            }
                            if (text) {
                                text.innerText = "Live";
                                text.className = "text-[10px] text-green-500 font-bold uppercase tracking-widest";
                            }
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error("‚ùå Channel error");
                            if (indicator) {
                                indicator.className = "w-2 h-2 bg-red-500 rounded-full";
                            }
                            if (text) {
                                text.innerText = "Error";
                                text.className = "text-[10px] text-red-500 font-bold uppercase tracking-widest";
                            }
                        } else if (status === 'TIMED_OUT') {
                            console.error("‚ùå Channel timeout");
                            if (indicator) {
                                indicator.className = "w-2 h-2 bg-orange-500 rounded-full";
                            }
                            if (text) {
                                text.innerText = "Timeout";
                                text.className = "text-[10px] text-orange-500 font-bold uppercase tracking-widest";
                            }
                        } else if (status === 'CLOSED') {
                            console.warn("‚ö†Ô∏è Channel closed");
                            if (indicator) {
                                indicator.className = "w-2 h-2 bg-gray-500 rounded-full";
                            }
                            if (text) {
                                text.innerText = "Closed";
                                text.className = "text-[10px] text-gray-500 font-bold uppercase tracking-widest";
                            }
                        }
                    });
                    
                    return true;
                } catch(e) { 
                    console.error("‚ùå Channel init error:", e);
                    return false; 
                }
            }
            return !!window.marqueeChannel;
        }

        var initInterval = setInterval(function() {
            if (initSupabase() && initMarqueeChannel()) {
                clearInterval(initInterval);
                console.log("‚úÖ Supabase Ready");
            }
        }, 1000);

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
          apiKey: "AIzaSyBR_Er6zVysY-J-ht8PMpKRW0FJ69utN3w",
          authDomain: "folkpresso.firebaseapp.com",
          databaseURL: "https://folkpresso-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "folkpresso",
          storageBucket: "folkpresso.firebasestorage.app",
          messagingSenderId: "728120023418",
          appId: "1:728120023418:web:62c8b1271da8af8a67dec3",
          measurementId: "G-4VRF8TV2E1"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === GLOBAL VARS ===
        var currentUser = "Guest";
        var userPoints = 0;
        var userCaffeine = 0;
        var currentTierStatus = "";
        var cart = [];
        var isStoreOpen = true;
        var communityGoal = 0;

        // === AUTH HANDLER ===
        auth.onAuthStateChanged((user) => {
            const loginScreen = document.getElementById('login-screen');
            const mainApp = document.getElementById('main-app');

            if (user) {
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                }, 500);
                startFolkSync(user.uid);
            } else {
                loginScreen.classList.remove('hidden');
                loginScreen.style.opacity = '1';
                mainApp.classList.add('hidden');
            }
        });

        window.loginWithGoogle = function() {
            const btn = document.querySelector('button[onclick*="loginWithGoogle"]');
            const text = document.getElementById('login-text');
            if(btn) btn.classList.add('opacity-50', 'pointer-events-none');
            if(text) text.innerText = "Membuka Google...";
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            // Deteksi mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Gunakan redirect untuk mobile, popup untuk desktop
            const loginMethod = isMobile ? 
                auth.signInWithRedirect(provider) : 
                auth.signInWithPopup(provider);
            
            if (isMobile) {
                console.log("üì± Mobile detected, using redirect...");
                return; // Redirect akan handle sendiri
            }
            
            // Untuk desktop (popup)
            loginMethod
                .then((result) => {
                    console.log("‚úÖ Login berhasil:", result.user.displayName);
                    const user = result.user;
                    
                    // Inisialisasi user baru di Firestore
                    const userRef = db.collection("users").doc(user.uid);
                    userRef.get().then((doc) => {
                        if (!doc.exists) {
                            userRef.set({
                                username: user.displayName,
                                customName: user.displayName,
                                email: user.email,
                                photo: user.photoURL,
                                points: 0,
                                caffeine: 0,
                                nameChangeCount: 0,
                                lastQuestDate: "",
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    });
                })
                .catch((error) => {
                    console.error("‚ùå Login error:", error);
                    if(btn) btn.classList.remove('opacity-50', 'pointer-events-none');
                    if(text) text.innerText = "Masuk dengan Google";
                    
                    if(error.code === 'auth/popup-closed-by-user') {
                        console.log("User menutup popup");
                    } else if(error.code === 'auth/popup-blocked') {
                        console.log("Popup diblokir, coba redirect...");
                        auth.signInWithRedirect(provider);
                    } else if(error.code === 'auth/unauthorized-domain') {
                        alert("Domain belum terdaftar di Firebase Console!");
                    } else {
                        alert("Login gagal: " + error.message);
                    }
                });
        };

        // Handle redirect result untuk mobile
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log("‚úÖ Login redirect berhasil:", result.user.displayName);
                const user = result.user;
                
                // Inisialisasi user baru di Firestore
                const userRef = db.collection("users").doc(user.uid);
                userRef.get().then((doc) => {
                    if (!doc.exists) {
                        userRef.set({
                            username: user.displayName,
                            customName: user.displayName,
                            email: user.email,
                            photo: user.photoURL,
                            points: 0,
                            caffeine: 0,
                            nameChangeCount: 0,
                            lastQuestDate: "",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            }
        }).catch((error) => {
            console.error("‚ùå Redirect error:", error);
        });

        function startFolkSync(uid) {
            db.collection("users").doc(uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    currentUser = data.customName || data.username || "Friend";
                    userPoints = data.points || 0;
                    userCaffeine = data.caffeine || 0;

                    const nameDisplay = document.getElementById('home-username');
                    const pointsDisplay = document.getElementById('home-points');
                    const profilePhoto = document.getElementById('profile-photo-nav');
                    
                    if(nameDisplay) nameDisplay.innerText = currentUser;
                    if(pointsDisplay) pointsDisplay.innerText = userPoints.toLocaleString();
                    if(profilePhoto && data.photo) profilePhoto.src = data.photo;
                    
                    checkQuestStatus(data.lastQuestDate);
                    updateMemberUI(); 
                }
            });
        }

        function checkQuestStatus(lastDate) {
            const today = new Date().toDateString();
            const btn = document.getElementById('quest-card');
            const status = document.getElementById('quest-status');
            if(!btn) return;
            if (lastDate === today) {
                btn.classList.add('opacity-50');
                if(status) status.innerText = "Terklaim ‚úÖ";
            } else {
                btn.classList.remove('opacity-50');
                if(status) status.innerText = "Klaim +50 Poin";
            }
        }

        function updateMemberUI() {
            var card = document.getElementById('member-card');
            var tierName = document.getElementById('tier-name');
            var bar = document.getElementById('level-bar');
            var dispPoints = document.getElementById('display-points');
            var cafMg = document.getElementById('caffeine-mg');
            var cafBar = document.getElementById('caffeine-bar');

            if (!card || !tierName || !bar || !dispPoints) return;

            dispPoints.innerText = userPoints.toLocaleString();
            
            var oldTier = currentTierStatus;
            var newTier = "";
            
            if(userPoints > 5000) {
                card.className = "member-card-gold rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6";
                tierName.innerText = "GOLD MEMBER üëë";
                bar.style.width = "100%";
                newTier = "GOLD MEMBER üëë";
            } else if (userPoints > 1000) {
                card.className = "member-card-silver rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6";
                tierName.innerText = "SILVER MEMBER ‚öîÔ∏è";
                bar.style.width = (userPoints / 5000 * 100) + "%";
                newTier = "SILVER MEMBER ‚öîÔ∏è";
            } else {
                card.className = "member-card-bronze rounded-[2rem] p-6 shadow-2xl relative overflow-hidden h-52 flex flex-col justify-between transition-all duration-500 mb-6";
                tierName.innerText = "BRONZE MEMBER";
                bar.style.width = (userPoints / 1000 * 100) + "%";
                newTier = "BRONZE MEMBER";
            }

            // Broadcast jika naik tier
            if (oldTier !== "" && oldTier !== newTier && window.marqueeChannel) {
                const broadcastMsg = `üëë Selamat! ${currentUser} naik ke ${newTier}!`;
                console.log("üì§ Sending tier broadcast:", broadcastMsg);
                
                // Tampilkan lokal dulu
                window.displayMarqueeMessage(broadcastMsg);
                
                // Kirim ke user lain
                window.marqueeChannel.send({
                    type: 'broadcast',
                    event: 'announcement',
                    payload: { message: broadcastMsg }
                }).then(() => {
                    console.log("‚úÖ Tier broadcast sent");
                }).catch((err) => {
                    console.error("‚ùå Tier broadcast error:", err);
                });
            }
            
            currentTierStatus = newTier;

            if (cafMg && cafBar) {
                cafMg.innerHTML = userCaffeine + '<span class="text-xs text-slate-400">mg</span>';
                cafBar.style.height = Math.min((userCaffeine / 500) * 100, 100) + "%";
            }
        }

        var products = [
            { name: "Aren Coffee", price: 15000, cost: 9000, type: "signature", mg: 80, image: "img/gula aren.png" },
            { name: "Salted Caramel", price: 15000, cost: 9000, type: "signature", mg: 60, image: "img/salted.png" },
            { name: "Caramel Macchiato", price: 15000, cost: 9000, type: "signature", mg: 120, image: "img/maciato.png" },
            { name: "Spanish Coffee", price: 15000, cost: 9000, type: "classic", mg: 100, image: "img/spanish.png" },
            { name: "Tiramisu", price: 15000, cost: 9000, type: "non-coffee", mg: 50, image: "img/tiramisu.png" },
            { name: "Hazelnut", price: 15000, cost: 9000, type: "non-coffee", mg: 60, image: "img/hazelnut.png" },
            { name: "Matcha Latte", price: 15000, cost: 9000, type: "non-coffee", mg: 40, image: "img/matcha.png" },
            { name: "Chocolate", price: 15000, cost: 9000, type: "non-coffee", mg: 10, image: "img/coklat.png" },
            { name: "Vanilla", price: 15000, cost: 9000, type: "non-coffee", mg: 50, image: "img/vanilla.png" }
        ];

        window.onload = function() {
            renderProducts(products);
            communityGoal = parseInt(localStorage.getItem('folkpresso_community_goal')) || 0;
            updateGoalUI();
        };

        function renderProducts(list) {
            var container = document.getElementById('product-list');
            if(!container) return;
            container.innerHTML = '';
            list.forEach(function(p) {
                var imgSrc = p.image && !p.image.startsWith("img/") ? p.image : "https://cdn-icons-png.flaticon.com/512/751/751621.png";
                container.innerHTML += `
                <div class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] border border-slate-100 dark:border-slate-800 flex items-center gap-4">
                    <div class="w-16 h-16 shrink-0"><img src="${imgSrc}" class="w-full h-full object-cover rounded-2xl shadow-sm bg-slate-50"></div>
                    <div class="flex-1 min-w-0"><h4 class="font-bold text-sm dark:text-white truncate">${p.name}</h4><p class="text-blue-600 dark:text-blue-400 font-black text-xs">Rp ${p.price.toLocaleString()}</p></div>
                    <button onclick="addToCart('${p.name}', ${p.price}, ${p.mg}, ${p.cost})" class="bg-blue-900 dark:bg-blue-600 text-white w-10 h-10 rounded-xl font-bold shrink-0 shadow-lg active:scale-90 transition-transform">+</button>
                </div>`;
            });
        }

        window.addToCart = function(name, price, mg, cost) {
            var item = cart.find(i => i.name === name);
            if(item) item.quantity++; else cart.push({name, price, mg, cost, quantity: 1});
            showToast(name + " ditambahkan!");
            renderCart();
        };

        function renderCart() {
            var list = document.getElementById('cart-items');
            if(!list) return;
            var total = 0;
            list.innerHTML = cart.length ? '' : '<p class="text-center text-slate-400 text-xs py-10 italic">Keranjang kosong...</p>';
            cart.forEach((item, index) => {
                total += item.price * item.quantity;
                list.innerHTML += `
                <div class="bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4 mb-3">
                    <div class="flex-1"><h4 class="font-extrabold text-sm dark:text-white">${item.name}</h4><p class="text-blue-600 dark:text-blue-400 text-xs">Rp ${(item.price * item.quantity).toLocaleString()}</p></div>
                    <div class="flex items-center bg-slate-50 dark:bg-slate-800 p-1.5 rounded-2xl">
                        <button onclick="updateQty(${index}, -1)" class="w-8 h-8 bg-white dark:bg-slate-700 text-slate-600 dark:text-white rounded-xl font-bold">-</button>
                        <span class="px-4 text-sm font-black dark:text-white">${item.quantity}</span>
                        <button onclick="updateQty(${index}, 1)" class="w-8 h-8 bg-blue-900 dark:bg-blue-600 text-white rounded-xl font-bold">+</button>
                    </div>
                </div>`;
            });
            const totalEl = document.getElementById('cart-total');
            if(totalEl) totalEl.innerText = 'Rp ' + total.toLocaleString();
        }

        window.updateQty = function(i, d) {
            cart[i].quantity += d;
            if(cart[i].quantity < 1) cart.splice(i, 1);
            renderCart();
        };

        // --- FUNGSI OPEN PAYMENT YANG DIPERBAIKI (SANGAT AMAN) ---
        window.openPayment = function() {
            if(!cart.length) return showToast("Keranjang kosong!");
            
            const modal = document.getElementById('payment-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex'); // Pastikan flex aktif
            } else {
                alert("Sistem Error: Modal tidak ditemukan. Hubungi Admin.");
            }
        };

        window.closePaymentModal = function() {
            const modal = document.getElementById('payment-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        window.processPayment = function(method) {
            closePaymentModal();
            const trackModal = document.getElementById('tracking-modal');
            const brewState = document.getElementById('brew-state');
            const finishState = document.getElementById('finish-state');
            const animBar = document.getElementById('anim-bar');

            if(trackModal && brewState && finishState && animBar) {
                trackModal.classList.remove('hidden');
                brewState.classList.remove('hidden');
                finishState.classList.add('hidden');
                animBar.style.width = "0%";
                
                submitTransaction(method);
                
                setTimeout(() => {
                    animBar.style.width = "100%";
                    setTimeout(() => {
                        brewState.classList.add('hidden');
                        finishState.classList.remove('hidden');
                    }, 500);
                }, 3000);
            }
        };

        async function submitTransaction(method) {
            const user = auth.currentUser;
            if(!user) return;
            
            let totalOrder = cart.reduce((a, b) => a + (b.price * b.quantity), 0);
            let totalCaffeine = cart.reduce((a, b) => a + (b.mg * b.quantity), 0);
            let totalCups = cart.reduce((a, b) => a + b.quantity, 0);

            communityGoal += totalCups;
            localStorage.setItem('folkpresso_community_goal', communityGoal);
            updateGoalUI();

            // Update Firestore (poin & caffeine)
            const userRef = db.collection("users").doc(user.uid);
            userRef.update({
                points: firebase.firestore.FieldValue.increment(Math.floor(totalOrder / 1000)),
                caffeine: firebase.firestore.FieldValue.increment(totalCaffeine)
            });

            // Kirim data transaksi ke Supabase
            const now = new Date();
            const dateStamp = now.toISOString().split('T')[0];
            const fullTimeStr = now.toLocaleDateString('id-ID') + " | " + now.toLocaleTimeString('id-ID');

            const payload = cart.map(item => ({
                date: dateStamp,
                full_time: fullTimeStr,
                name: item.name,
                type: 'in',
                qty: item.quantity,
                unit_price: item.price,
                unit_cost: item.cost || 0,
                total: item.price * item.quantity,
                method: method,
                payment_status: 'success',
                location: '-',
                netto: '-',
                notes: '-'
            }));

            if (window.supabaseClient) {
                try {
                    console.log("üì§ Mengirim data ke Supabase...", payload);
                    const { data, error } = await window.supabaseClient
                        .from('transactions')
                        .insert(payload);
                    
                    if (error) {
                        console.error("‚ùå Supabase Error:", error);
                        showToast("‚ö†Ô∏è Gagal sync database: " + error.message);
                    } else {
                        console.log("‚úÖ Data berhasil dikirim ke Supabase!");
                    }
                } catch (err) {
                    console.error("‚ùå Error saat kirim data:", err);
                    showToast("‚ö†Ô∏è Error koneksi: " + err.message);
                }
            } else {
                console.warn("‚ö†Ô∏è Supabase client belum siap, data hanya tersimpan lokal");
                showToast("‚ö†Ô∏è Mode offline - data tersimpan lokal");
            }

            // Broadcast pesan
            if(window.marqueeChannel) {
                const orderDetails = cart.map(item => item.quantity + "x " + item.name).join(", ");
                const broadcastMsg = `‚òï ${currentUser} baru saja memesan ${orderDetails} via ${method}!`;
                console.log("üì§ Sending broadcast:", broadcastMsg);
                
                // Tampilkan lokal dulu (untuk user yang order)
                window.displayMarqueeMessage(broadcastMsg);
                
                // Kirim ke user lain via broadcast
                window.marqueeChannel.send({
                    type: 'broadcast',
                    event: 'announcement',
                    payload: { message: broadcastMsg }
                }).then(() => {
                    console.log("‚úÖ Broadcast sent successfully");
                }).catch((err) => {
                    console.error("‚ùå Broadcast error:", err);
                });
            } else {
                console.warn("‚ö†Ô∏è Marquee channel not available");
            }
        }

        window.finishOrder = function() {
            document.getElementById('tracking-modal').classList.add('hidden');
            cart = [];
            renderCart();
            showPage('home');
            showToast("Pesanan selesai! Poin bertambah.");
        };

        window.showPage = function(id) {
            document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(id + '-page');
            if(target) target.classList.add('active');
            
            document.querySelectorAll('nav button').forEach(b => {
                b.className = "flex flex-col items-center text-slate-400";
            });
            const btn = document.getElementById('btn-' + id);
            if(btn) btn.className = "flex flex-col items-center text-blue-900 dark:text-blue-400";

            if(id === 'cart') renderCart();
            if(id === 'profile') updateMemberUI();
        };

        function showToast(msg) {
            var container = document.getElementById('toast-container');
            if(!container) return;
            var t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        function updateGoalUI() {
            var goalPercent = Math.min((communityGoal / 20) * 100, 100);
            const bar = document.getElementById('goal-bar');
            const txt = document.getElementById('goal-counter');
            if(bar) bar.style.width = goalPercent + "%";
            if(txt) txt.innerText = communityGoal + " / 20 Cups";
        }

        window.toggleDark = function() { document.documentElement.classList.toggle('dark'); };

        // Fungsi test marquee untuk debugging
        window.testMarquee = function() {
            console.log("üß™ Testing marquee...");
            console.log("Channel status:", window.marqueeChannel ? "Connected" : "Not connected");
            
            if (window.marqueeChannel) {
                const testMsg = `üß™ Test dari ${currentUser} - ${new Date().toLocaleTimeString()}`;
                console.log("Sending test message:", testMsg);
                
                // Display lokal
                window.displayMarqueeMessage(testMsg);
                
                // Broadcast ke user lain
                window.marqueeChannel.send({
                    type: 'broadcast',
                    event: 'announcement',
                    payload: { message: testMsg }
                }).then(() => {
                    console.log("‚úÖ Test message sent");
                }).catch((err) => {
                    console.error("‚ùå Test message error:", err);
                });
            } else {
                console.error("‚ùå Channel not initialized");
                alert("Channel belum terhubung! Cek console untuk detail.");
            }
        };

        // Test multiple messages (simulasi 3 user order bersamaan)
        window.testMultipleMarquee = function() {
            console.log("üß™ Testing multiple messages...");
            
            // Simulasi 3 user order bersamaan
            setTimeout(() => {
                window.displayMarqueeMessage("‚òï User A memesan 2x Aren Coffee via Cash!");
            }, 100);
            
            setTimeout(() => {
                window.displayMarqueeMessage("‚òï User B memesan 1x Salted Caramel via QRIS!");
            }, 200);
            
            setTimeout(() => {
                window.displayMarqueeMessage("‚öîÔ∏è User C berhasil claim Daily Quest +50 poin!");
            }, 300);
            
            console.log("‚úÖ 3 messages queued, check marquee!");
        };
        window.logout = function() { 
            if(confirm("Yakin mau keluar?")) {
                auth.signOut().then(() => location.reload()); 
            }
        };

        window.claimQuest = function() {
            const user = auth.currentUser;
            if(!user) return;
            const userRef = db.collection("users").doc(user.uid);
            const today = new Date().toDateString();

            userRef.get().then((doc) => {
                if(doc.exists && doc.data().lastQuestDate === today) {
                    showToast("Sudah diklaim hari ini!");
                } else {
                    userRef.update({
                        points: firebase.firestore.FieldValue.increment(50),
                        lastQuestDate: today
                    }).then(() => {
                        showToast("üéâ +50 Poin Quest!");
                        
                        // Broadcast pesan daily quest
                        if(window.marqueeChannel) {
                            const broadcastMsg = `‚öîÔ∏è ${currentUser} berhasil claim Daily Quest +50 poin!`;
                            console.log("üì§ Sending quest broadcast:", broadcastMsg);
                            
                            // Tampilkan lokal dulu
                            window.displayMarqueeMessage(broadcastMsg);
                            
                            // Kirim ke user lain
                            window.marqueeChannel.send({
                                type: 'broadcast',
                                event: 'announcement',
                                payload: { message: broadcastMsg }
                            }).then(() => {
                                console.log("‚úÖ Quest broadcast sent");
                            }).catch((err) => {
                                console.error("‚ùå Quest broadcast error:", err);
                            });
                        }
                    });
                }
            });
        };

        window.updateCustomName = function() {
            const user = auth.currentUser;
            const name = document.getElementById('input-username').value;
            if(user && name) {
                db.collection("users").doc(user.uid).update({ customName: name });
                showToast("Nama diupdate!");
            }
        };

        window.mysteryBrew = function() {
            var random = products[Math.floor(Math.random() * products.length)];
            window.addToCart(random.name, random.price, random.mg, random.cost);
            showToast("‚ú® " + random.name + " terpilih!");
        };
    </script>
</body>
</html>